module.exports=[22734,(e,t,i)=>{t.exports=e.x("fs",()=>require("fs"))},68437,(e,t,i)=>{let s=e.r(22734),r=e.r(14747),n=/('[^']*(\\.[^'\\]*)*')/,a=/("[^"]*(\\.[^"\\]*)*")/,o=(e,t,i)=>{throw Error("Missing value for statement.\n"+e+" not provided for statement:\n"+t+"\nthis was provided:\n"+JSON.stringify(i))};t.exports=(e,i={})=>s.readdirSync(e).filter(e=>e.endsWith(".sql")).map(t=>({name:t,content:s.readFileSync(r.resolve(e,t),"utf8").replace(/\r\n/g,"\n")})).reduce((e,s)=>(e[s.name]=s.content,s.content.split("\n\n").reduce((e,t)=>(t.trim().startsWith("--")?e.push(t):e.length&&(e[e.length-1]+="\n\n"+t),e),[]).forEach(s=>{if(s.trim().startsWith("--")){let r=s.split("\n")[0].trim().substring(2).trim();if(e[r])throw Error('Duplicate SQL query name "'+r+'" found, please rename other one.');e[r]=i.type?t.exports[i.type](s,i):s}}),e),{}),t.exports.pg=(e,t={})=>(i={})=>{let s=[];return{text:e.replace(/--.*$/gm,"").replace(/\/\*(\*(?!\/)|[^*])*\*\//g,"").split(n).map(r=>!r||n.test(r)?r:r.split(a).map(r=>!r||a.test(r)?r:r.replace(/(::?)([a-zA-Z0-9_]+)/g,(r,n,a)=>":"!==n?n+a:a in i?(s.push(i[a]),"$"+s.length):t.useNullForMissing?(s.push(null),"$"+s.length):o(a,e,i))).join("")).join("").trim(),values:s}},t.exports.mysql=(e,t={})=>(i={})=>{let s=[];return{sql:e.split(n).map(r=>!r||n.test(r)?r:r.split(a).map(r=>!r||a.test(r)?r:r.replace(/(::?)([a-zA-Z0-9_]+)/g,(r,n,a)=>a in i?(s.push(i[a]),n.replace(/:/g,"?")):t.useNullForMissing?(s.push(null),n.replace(/:/g,"?")):o(a,e,i))).join("")).join("").trim(),values:s}}},49430,(e,t,i)=>{"use strict";i.parse=function(e,t){return new s(e,t).parse()};class s{constructor(e,t){this.source=e,this.transform=t||r,this.position=0,this.entries=[],this.recorded=[],this.dimension=0}isEof(){return this.position>=this.source.length}nextCharacter(){var e=this.source[this.position++];return"\\"===e?{value:this.source[this.position++],escaped:!0}:{value:e,escaped:!1}}record(e){this.recorded.push(e)}newEntry(e){var t;(this.recorded.length>0||e)&&("NULL"!==(t=this.recorded.join(""))||e||(t=null),null!==t&&(t=this.transform(t)),this.entries.push(t),this.recorded=[])}consumeDimensions(){if("["===this.source[0])for(;!this.isEof()&&"="!==this.nextCharacter().value;);}parse(e){var t,i,r;for(this.consumeDimensions();!this.isEof();)if("{"!==(t=this.nextCharacter()).value||r){if("}"!==t.value||r)'"'!==t.value||t.escaped?","!==t.value||r?this.record(t.value):this.newEntry():(r&&this.newEntry(!0),r=!r);else if(this.dimension--,!this.dimension&&(this.newEntry(),e))return this.entries}else this.dimension++,this.dimension>1&&(i=new s(this.source.substr(this.position-1),this.transform),this.entries.push(i.parse(!0)),this.position+=i.position-2);if(0!==this.dimension)throw Error("array dimension not balanced");return this.entries}}function r(e){return e}},43264,(e,t,i)=>{var s=e.r(49430);t.exports={create:function(e,t){return{parse:function(){return s.parse(e,t)}}}}},82697,(e,t,i)=>{"use strict";var s=/(\d{1,})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})(\.\d{1,})?.*?( BC)?$/,r=/^(\d{1,})-(\d{2})-(\d{2})( BC)?$/,n=/([Z+-])(\d{2})?:?(\d{2})?:?(\d{2})?/,a=/^-?infinity$/;t.exports=function(e){if(a.test(e))return Number(e.replace("i","I"));var t,i=s.exec(e);if(!i)return function(e){var t=r.exec(e);if(t){var i=parseInt(t[1],10);t[4]&&(i=function(e){return-(e-1)}(i));var s=new Date(i,parseInt(t[2],10)-1,t[3]);return o(i)&&s.setFullYear(i),s}}(e)||null;var c=!!i[8],l=parseInt(i[1],10);c&&(l=-(l-1));var h=parseInt(i[2],10)-1,u=i[3],d=parseInt(i[4],10),p=parseInt(i[5],10),f=parseInt(i[6],10),m=i[7];m=m?1e3*parseFloat(m):0;var g=function(e){if(e.endsWith("+00"))return 0;var t=n.exec(e.split(" ")[1]);if(t){var i=t[1];return"Z"===i?0:(3600*parseInt(t[2],10)+60*parseInt(t[3]||0,10)+parseInt(t[4]||0,10))*("-"===i?-1:1)*1e3}}(e);return null!=g?(t=new Date(Date.UTC(l,h,u,d,p,f,m)),o(l)&&t.setUTCFullYear(l),0!==g&&t.setTime(t.getTime()-g)):(t=new Date(l,h,u,d,p,f,m),o(l)&&t.setFullYear(l)),t};function o(e){return e>=0&&e<100}},24221,(e,t,i)=>{t.exports=function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)s.call(i,r)&&(e[r]=i[r])}return e};var s=Object.prototype.hasOwnProperty},75668,(e,t,i)=>{"use strict";var s=e.r(24221);function r(e){if(!(this instanceof r))return new r(e);s(this,function(e){if(!e)return{};var t=h.exec(e),i="-"===t[8];return Object.keys(u).reduce(function(e,s){var r,n=t[u[s]];return n?((n="milliseconds"===s?parseInt((r=n)+"000000".slice(r.length),10)/1e3:parseInt(n,10))&&(i&&~d.indexOf(s)&&(n*=-1),e[s]=n),e):e},{})}(e))}t.exports=r;var n=["seconds","minutes","hours","days","months","years"];r.prototype.toPostgres=function(){var e=n.filter(this.hasOwnProperty,this);return(this.milliseconds&&0>e.indexOf("seconds")&&e.push("seconds"),0===e.length)?"0":e.map(function(e){var t=this[e]||0;return"seconds"===e&&this.milliseconds&&(t=(t+this.milliseconds/1e3).toFixed(6).replace(/\.?0+$/,"")),t+" "+e},this).join(" ")};var a={years:"Y",months:"M",days:"D",hours:"H",minutes:"M",seconds:"S"},o=["years","months","days"],c=["hours","minutes","seconds"];r.prototype.toISOString=r.prototype.toISO=function(){return"P"+o.map(e,this).join("")+"T"+c.map(e,this).join("");function e(e){var t=this[e]||0;return"seconds"===e&&this.milliseconds&&(t=(t+this.milliseconds/1e3).toFixed(6).replace(/0+$/,"")),t+a[e]}};var l="([+-]?\\d+)",h=new RegExp([l+"\\s+years?",l+"\\s+mons?",l+"\\s+days?","([+-])?([\\d]*):(\\d\\d):(\\d\\d)\\.?(\\d{1,6})?"].map(function(e){return"("+e+")?"}).join("\\s*")),u={years:2,months:4,days:6,hours:9,minutes:10,seconds:11,milliseconds:12},d=["hours","minutes","seconds","milliseconds"]},9587,(e,t,i)=>{"use strict";var s=Buffer.from||Buffer;t.exports=function(e){if(/^\\x/.test(e))return s(e.substr(2),"hex");for(var t="",i=0;i<e.length;)if("\\"!==e[i])t+=e[i],++i;else if(/[0-7]{3}/.test(e.substr(i+1,3)))t+=String.fromCharCode(parseInt(e.substr(i+1,3),8)),i+=4;else{for(var r=1;i+r<e.length&&"\\"===e[i+r];)r++;for(var n=0;n<Math.floor(r/2);++n)t+="\\";i+=2*Math.floor(r/2)}return s(t,"binary")}},17009,(e,t,i)=>{var s=e.r(49430),r=e.r(43264),n=e.r(82697),a=e.r(75668),o=e.r(9587);function c(e){return function(t){return null===t?t:e(t)}}function l(e){return null===e?e:"TRUE"===e||"t"===e||"true"===e||"y"===e||"yes"===e||"on"===e||"1"===e}function h(e){return e?s.parse(e,l):null}function u(e){return parseInt(e,10)}function d(e){return e?s.parse(e,c(u)):null}function p(e){return e?s.parse(e,c(function(e){return E(e).trim()})):null}var f=function(e){return e?r.create(e,function(e){return null!==e&&(e=S(e)),e}).parse():null},m=function(e){return e?r.create(e,function(e){return null!==e&&(e=parseFloat(e)),e}).parse():null},g=function(e){return e?r.create(e).parse():null},y=function(e){return e?r.create(e,function(e){return null!==e&&(e=n(e)),e}).parse():null},b=function(e){return e?r.create(e,function(e){return null!==e&&(e=a(e)),e}).parse():null},w=function(e){return e?s.parse(e,c(o)):null},_=function(e){return parseInt(e,10)},E=function(e){var t=String(e);return/^\d+$/.test(t)?t:e},v=function(e){return e?s.parse(e,c(JSON.parse)):null},S=function(e){return"("!==e[0]?null:{x:parseFloat((e=e.substring(1,e.length-1).split(","))[0]),y:parseFloat(e[1])}},C=function(e){if("<"!==e[0]&&"("!==e[1])return null;for(var t="(",i="",s=!1,r=2;r<e.length-1;r++){if(s||(t+=e[r]),")"===e[r]){s=!0;continue}s&&","!==e[r]&&(i+=e[r])}var n=S(t);return n.radius=parseFloat(i),n};t.exports={init:function(e){e(20,E),e(21,_),e(23,_),e(26,_),e(700,parseFloat),e(701,parseFloat),e(16,l),e(1082,n),e(1114,n),e(1184,n),e(600,S),e(651,g),e(718,C),e(1e3,h),e(1001,w),e(1005,d),e(1007,d),e(1028,d),e(1016,p),e(1017,f),e(1021,m),e(1022,m),e(1231,m),e(1014,g),e(1015,g),e(1008,g),e(1009,g),e(1040,g),e(1041,g),e(1115,y),e(1182,y),e(1185,y),e(1186,a),e(1187,b),e(17,o),e(114,JSON.parse.bind(JSON)),e(3802,JSON.parse.bind(JSON)),e(199,v),e(3807,v),e(3907,g),e(2951,g),e(791,g),e(1183,g),e(1270,g)}}},15917,(e,t,i)=>{"use strict";t.exports=function(e){var t,i,s,r,n,a,o=e.readInt32BE(0),c=e.readUInt32BE(4),l="";o<0&&(o=~o+(0===c),c=~c+1>>>0,l="-");var h="";if(t=o%1e6,o=o/1e6>>>0,c=(i=0x100000000*t+c)/1e6>>>0,s=""+(i-1e6*c),0===c&&0===o)return l+s+h;for(a=0,r="",n=6-s.length;a<n;a++)r+="0";if(h=r+s+h,t=o%1e6,o=o/1e6>>>0,c=(i=0x100000000*t+c)/1e6>>>0,s=""+(i-1e6*c),0===c&&0===o)return l+s+h;for(a=0,r="",n=6-s.length;a<n;a++)r+="0";if(h=r+s+h,t=o%1e6,o=o/1e6>>>0,c=(i=0x100000000*t+c)/1e6>>>0,s=""+(i-1e6*c),0===c&&0===o)return l+s+h;for(a=0,r="",n=6-s.length;a<n;a++)r+="0";return h=r+s+h,l+(s=""+(i=0x100000000*(t=o%1e6)+c)%1e6)+h}},95132,(e,t,i)=>{var s=e.r(15917),r=function(e,t,i,s,r){i=i||0,s=s||!1,r=r||function(e,t,i){return e*Math.pow(2,i)+t};var n=i>>3,a=function(e){return s?255&~e:e},o=255,c=8-i%8;t<c&&(o=255<<8-t&255,c=t),i&&(o>>=i%8);var l=0;i%8+t>=8&&(l=r(0,a(e[n])&o,c));for(var h=t+i>>3,u=n+1;u<h;u++)l=r(l,a(e[u]),8);var d=(t+i)%8;return d>0&&(l=r(l,a(e[h])>>8-d,d)),l},n=function(e,t,i){var s=Math.pow(2,i-1)-1,n=r(e,1),a=r(e,i,1);if(0===a)return 0;var o=1,c=r(e,t,i+1,!1,function(e,t,i){0===e&&(e=1);for(var s=1;s<=i;s++)o/=2,(t&1<<i-s)>0&&(e+=o);return e});return a==Math.pow(2,i+1)-1?0===c?0===n?1/0:-1/0:NaN:(0===n?1:-1)*Math.pow(2,a-s)*c},a=function(e){return 1==r(e,1)?-1*(r(e,15,1,!0)+1):r(e,15,1)},o=function(e){return 1==r(e,1)?-1*(r(e,31,1,!0)+1):r(e,31,1)},c=function(e){return n(e,23,8)},l=function(e){return n(e,52,11)},h=function(e){var t=r(e,16,32);if(49152==t)return NaN;for(var i=Math.pow(1e4,r(e,16,16)),s=0,n=r(e,16),a=0;a<n;a++)s+=r(e,16,64+16*a)*i,i/=1e4;var o=Math.pow(10,r(e,16,48));return(0===t?1:-1)*Math.round(s*o)/o},u=function(e,t){var i=r(t,1),s=r(t,63,1),n=new Date((0===i?1:-1)*s/1e3+9466848e5);return e||n.setTime(n.getTime()+6e4*n.getTimezoneOffset()),n.usec=s%1e3,n.getMicroSeconds=function(){return this.usec},n.setMicroSeconds=function(e){this.usec=e},n.getUTCMicroSeconds=function(){return this.usec},n},d=function(e){var t=r(e,32);r(e,32,32);for(var i=r(e,32,64),s=96,n=[],a=0;a<t;a++)n[a]=r(e,32,s),s+=64;var o=function(t){var i,n=r(e,32,s);return(s+=32,0xffffffff==n)?null:23==t||20==t?(i=r(e,8*n,s),s+=8*n,i):25==t?i=e.toString(this.encoding,s>>3,(s+=n<<3)>>3):void console.log("ERROR: ElementType not implemented: "+t)},c=function(e,t){var i,s=[];if(e.length>1){var r=e.shift();for(i=0;i<r;i++)s[i]=c(e,t);e.unshift(r)}else for(i=0;i<e[0];i++)s[i]=o(t);return s};return c(n,i)},p=function(e){return e.toString("utf8")},f=function(e){return null===e?null:r(e,8)>0};t.exports={init:function(e){e(20,s),e(21,a),e(23,o),e(26,o),e(1700,h),e(700,c),e(701,l),e(16,f),e(1114,u.bind(null,!1)),e(1184,u.bind(null,!0)),e(1e3,d),e(1007,d),e(1016,d),e(1008,d),e(1009,d),e(25,p)}}},97571,(e,t,i)=>{t.exports={BOOL:16,BYTEA:17,CHAR:18,INT8:20,INT2:21,INT4:23,REGPROC:24,TEXT:25,OID:26,TID:27,XID:28,CID:29,JSON:114,XML:142,PG_NODE_TREE:194,SMGR:210,PATH:602,POLYGON:604,CIDR:650,FLOAT4:700,FLOAT8:701,ABSTIME:702,RELTIME:703,TINTERVAL:704,CIRCLE:718,MACADDR8:774,MONEY:790,MACADDR:829,INET:869,ACLITEM:1033,BPCHAR:1042,VARCHAR:1043,DATE:1082,TIME:1083,TIMESTAMP:1114,TIMESTAMPTZ:1184,INTERVAL:1186,TIMETZ:1266,BIT:1560,VARBIT:1562,NUMERIC:1700,REFCURSOR:1790,REGPROCEDURE:2202,REGOPER:2203,REGOPERATOR:2204,REGCLASS:2205,REGTYPE:2206,UUID:2950,TXID_SNAPSHOT:2970,PG_LSN:3220,PG_NDISTINCT:3361,PG_DEPENDENCIES:3402,TSVECTOR:3614,TSQUERY:3615,GTSVECTOR:3642,REGCONFIG:3734,REGDICTIONARY:3769,JSONB:3802,REGNAMESPACE:4089,REGROLE:4096}},85306,(e,t,i)=>{var s=e.r(17009),r=e.r(95132),n=e.r(43264),a=e.r(97571);i.getTypeParser=function(e,t){return o[t=t||"text"]&&o[t][e]||c},i.setTypeParser=function(e,t,i){"function"==typeof t&&(i=t,t="text"),o[t][e]=i},i.arrayParser=n,i.builtins=a;var o={text:{},binary:{}};function c(e){return String(e)}s.init(function(e,t){o.text[e]=t}),r.init(function(e,t){o.binary[e]=t})},91011,(e,t,i)=>{"use strict";let s;try{s=process.env.USER}catch{}t.exports={host:"localhost",user:s,database:void 0,password:null,connectionString:void 0,port:5432,rows:0,binary:!1,max:10,idleTimeoutMillis:3e4,client_encoding:"",ssl:!1,application_name:void 0,fallback_application_name:void 0,options:void 0,parseInputDatesAsUTC:!1,statement_timeout:!1,lock_timeout:!1,idle_in_transaction_session_timeout:!1,query_timeout:!1,connect_timeout:0,keepalives:1,keepalives_idle:0};let r=e.r(85306),n=r.getTypeParser(20,"text"),a=r.getTypeParser(1016,"text");t.exports.__defineSetter__("parseInt8",function(e){r.setTypeParser(20,"text",e?r.getTypeParser(23,"text"):n),r.setTypeParser(1016,"text",e?r.getTypeParser(1007,"text"):a)})},78076,(e,t,i)=>{"use strict";let s=e.r(91011),r=e.r(24361),{isDate:n}=r.types||r,a=function(e,t){if(null==e)return null;if("object"==typeof e){var i,r;if(e instanceof Buffer)return e;if(ArrayBuffer.isView(e)){let t=Buffer.from(e.buffer,e.byteOffset,e.byteLength);return t.length===e.byteLength?t:t.slice(e.byteOffset,e.byteOffset+e.byteLength)}if(n(e))if(s.parseInputDatesAsUTC){let t,s,r;return(s=(t=(i=e).getUTCFullYear())<1)&&(t=Math.abs(t)+1),r=String(t).padStart(4,"0")+"-"+String(i.getUTCMonth()+1).padStart(2,"0")+"-"+String(i.getUTCDate()).padStart(2,"0")+"T"+String(i.getUTCHours()).padStart(2,"0")+":"+String(i.getUTCMinutes()).padStart(2,"0")+":"+String(i.getUTCSeconds()).padStart(2,"0")+"."+String(i.getUTCMilliseconds()).padStart(3,"0")+"+00:00",s&&(r+=" BC"),r}else{let t,i,s,n;return t=-(r=e).getTimezoneOffset(),(s=(i=r.getFullYear())<1)&&(i=Math.abs(i)+1),n=String(i).padStart(4,"0")+"-"+String(r.getMonth()+1).padStart(2,"0")+"-"+String(r.getDate()).padStart(2,"0")+"T"+String(r.getHours()).padStart(2,"0")+":"+String(r.getMinutes()).padStart(2,"0")+":"+String(r.getSeconds()).padStart(2,"0")+"."+String(r.getMilliseconds()).padStart(3,"0"),t<0?(n+="-",t*=-1):n+="+",n+=String(Math.floor(t/60)).padStart(2,"0")+":"+String(t%60).padStart(2,"0"),s&&(n+=" BC"),n}return Array.isArray(e)?function e(t){let i="{";for(let s=0;s<t.length;s++)if(s>0&&(i+=","),null===t[s]||void 0===t[s])i+="NULL";else if(Array.isArray(t[s]))i+=e(t[s]);else if(ArrayBuffer.isView(t[s])){let e=t[s];if(!(e instanceof Buffer)){let t=Buffer.from(e.buffer,e.byteOffset,e.byteLength);e=t.length===e.byteLength?t:t.slice(e.byteOffset,e.byteOffset+e.byteLength)}i+="\\\\x"+e.toString("hex")}else i+='"'+a(t[s]).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"';return i+"}"}(e):function(e,t){if(e&&"function"==typeof e.toPostgres){if(-1!==(t=t||[]).indexOf(e))throw Error('circular reference detected while preparing "'+e+'" for query');return t.push(e),a(e.toPostgres(a),t)}return JSON.stringify(e)}(e,t)}return e.toString()};t.exports={prepareValue:function(e){return a(e)},normalizeQueryConfig:function(e,t,i){return e="string"==typeof e?{text:e}:e,t&&("function"==typeof t?e.callback=t:e.values=t),i&&(e.callback=i),e},escapeIdentifier:function(e){return'"'+e.replace(/"/g,'""')+'"'},escapeLiteral:function(e){let t=!1,i="'";if(null==e||"string"!=typeof e)return"''";for(let s=0;s<e.length;s++){let r=e[s];"'"===r?i+=r+r:"\\"===r?(i+=r+r,t=!0):i+=r}return i+="'",!0===t&&(i=" E"+i),i}}},38794,(e,t,i)=>{let s=e.r(54799);t.exports={postgresMd5PasswordHash:c,randomBytes:function(e){return r.getRandomValues(Buffer.alloc(e))},deriveKey:d,sha256:l,hashByName:h,hmacSha256:u,md5:o};let r=s.webcrypto||globalThis.crypto,n=r.subtle,a=new TextEncoder;async function o(e){try{return s.createHash("md5").update(e,"utf-8").digest("hex")}catch(i){let t="string"==typeof e?a.encode(e):e;return Array.from(new Uint8Array(await n.digest("MD5",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}}async function c(e,t,i){let s=await o(t+e);return"md5"+await o(Buffer.concat([Buffer.from(s),i]))}async function l(e){return await n.digest("SHA-256",e)}async function h(e,t){return await n.digest(e,t)}async function u(e,t){let i=await n.importKey("raw",e,{name:"HMAC",hash:"SHA-256"},!1,["sign"]);return await n.sign("HMAC",i,a.encode(t))}async function d(e,t,i){let s=await n.importKey("raw",a.encode(e),"PBKDF2",!1,["deriveBits"]);return await n.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:t,iterations:i},s,256,["deriveBits"])}},83707,(e,t,i)=>{"use strict";let s=e.r(54799);function r(e){return s.createHash("md5").update(e,"utf-8").digest("hex")}async function n(e,t,i){return s.pbkdf2Sync(e,t,i,32,"sha256")}t.exports={postgresMd5PasswordHash:function(e,t,i){let s=r(t+e);return"md5"+r(Buffer.concat([Buffer.from(s),i]))},randomBytes:s.randomBytes,deriveKey:n,sha256:function(e){return s.createHash("sha256").update(e).digest()},hashByName:function(e,t){return e=e.replace(/(\D)-/,"$1"),s.createHash(e).update(t).digest()},hmacSha256:function(e,t){return s.createHmac("sha256",e).update(t).digest()},md5:r}},73265,(e,t,i)=>{"use strict";15>parseInt(process.versions&&process.versions.node&&process.versions.node.split(".")[0])?t.exports=e.r(83707):t.exports=e.r(38794)},75664,(e,t,i)=>{function s(e,t){return Error("SASL channel binding: "+e+" when parsing public certificate "+t.toString("base64"))}function r(e,t){let i=e[t++];if(i<128)return{length:i,index:t};let r=127&i;if(r>4)throw s("bad length",e);i=0;for(let s=0;s<r;s++)i=i<<8|e[t++];return{length:i,index:t}}function n(e,t){if(6!==e[t++])throw s("non-OID data",e);let{length:i,index:n}=r(e,t),a=(t=n)+i,o=e[t++],c=(o/40|0)+"."+o%40;for(;t<a;){let i=0;for(;t<a;){let s=e[t++];if(i=i<<7|127&s,s<128)break}c+="."+i}return{oid:c,index:t}}function a(e,t){if(48!==e[t++])throw s("non-sequence data",e);return r(e,t)}t.exports={signatureAlgorithmHashFromCertificate:function(e,t){void 0===t&&(t=0),t=a(e,t).index;let{length:i,index:o}=a(e,t);t=a(e,t=o+i).index;let{oid:c,index:l}=n(e,t);switch(c){case"1.2.840.113549.1.1.4":return"MD5";case"1.2.840.113549.1.1.5":case"1.2.840.10045.4.1":return"SHA-1";case"1.2.840.113549.1.1.11":case"1.2.840.10045.4.3.2":return"SHA-256";case"1.2.840.113549.1.1.12":case"1.2.840.10045.4.3.3":return"SHA-384";case"1.2.840.113549.1.1.13":case"1.2.840.10045.4.3.4":case"1.3.101.110":case"1.3.101.112":return"SHA-512";case"1.2.840.113549.1.1.14":case"1.2.840.10045.4.3.1":return"SHA-224";case"1.2.840.113549.1.1.15":return"SHA512-224";case"1.2.840.113549.1.1.16":return"SHA512-256";case"1.2.840.113549.1.1.10":{if(t=a(e,t=l).index,160!==e[t++])throw s("non-tag data",e);t=r(e,t).index,t=a(e,t).index;let{oid:i}=n(e,t);switch(i){case"1.2.840.113549.2.5":return"MD5";case"1.3.14.3.2.26":return"SHA-1";case"2.16.840.1.101.3.4.2.1":return"SHA-256";case"2.16.840.1.101.3.4.2.2":return"SHA-384";case"2.16.840.1.101.3.4.2.3":return"SHA-512"}throw s("unknown hash OID "+i,e)}case"1.3.101.111":case"1.3.101.113":throw s("Ed448 certificate channel binding is not currently supported by Postgres")}throw s("unknown OID "+c,e)}}},45978,(e,t,i)=>{"use strict";let s=e.r(73265),{signatureAlgorithmHashFromCertificate:r}=e.r(75664);function n(e){return/^(?:[a-zA-Z0-9+/]{4})*(?:[a-zA-Z0-9+/]{2}==|[a-zA-Z0-9+/]{3}=)?$/.test(e)}function a(e){if("string"!=typeof e)throw TypeError("SASL: attribute pairs text must be a string");return new Map(e.split(",").map(e=>{if(!/^.=/.test(e))throw Error("SASL: Invalid attribute pair entry");return[e[0],e.substring(2)]}))}t.exports={startSession:function(e,t){let i=["SCRAM-SHA-256"];t&&i.unshift("SCRAM-SHA-256-PLUS");let r=i.find(t=>e.includes(t));if(!r)throw Error("SASL: Only mechanism(s) "+i.join(" and ")+" are supported");if("SCRAM-SHA-256-PLUS"===r&&"function"!=typeof t.getPeerCertificate)throw Error("SASL: Mechanism SCRAM-SHA-256-PLUS requires a certificate");let n=s.randomBytes(18).toString("base64"),a="SCRAM-SHA-256-PLUS"===r?"p=tls-server-end-point":t?"y":"n";return{mechanism:r,clientNonce:n,response:a+",,n=*,r="+n,message:"SASLInitialResponse"}},continueSession:async function e(e,t,i,o){if("SASLInitialResponse"!==e.message)throw Error("SASL: Last message was not SASLInitialResponse");if("string"!=typeof t)throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a string");if(""===t)throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: client password must be a non-empty string");if("string"!=typeof i)throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: serverData must be a string");let c=function(e){let t=a(e),i=t.get("r");if(i){if(!function(e){if("string"!=typeof e)throw TypeError("SASL: text must be a string");return e.split("").map((t,i)=>e.charCodeAt(i)).every(e=>e>=33&&e<=43||e>=45&&e<=126)}(i))throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce must only contain printable characters")}else throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: nonce missing");let s=t.get("s");if(s){if(!n(s))throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt must be base64")}else throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: salt missing");let r=t.get("i");if(r){if(!/^[1-9][0-9]*$/.test(r))throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: invalid iteration count")}else throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: iteration missing");return{nonce:i,salt:s,iteration:parseInt(r,10)}}(i);if(c.nonce.startsWith(e.clientNonce)){if(c.nonce.length===e.clientNonce.length)throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce is too short")}else throw Error("SASL: SCRAM-SERVER-FIRST-MESSAGE: server nonce does not start with client nonce");let l="n=*,r="+e.clientNonce,h="r="+c.nonce+",s="+c.salt+",i="+c.iteration,u=o?"eSws":"biws";if("SCRAM-SHA-256-PLUS"===e.mechanism){let e=o.getPeerCertificate().raw,t=r(e);("MD5"===t||"SHA-1"===t)&&(t="SHA-256");let i=await s.hashByName(t,e);u=Buffer.concat([Buffer.from("p=tls-server-end-point,,"),Buffer.from(i)]).toString("base64")}let d="c="+u+",r="+c.nonce,p=l+","+h+","+d,f=Buffer.from(c.salt,"base64"),m=await s.deriveKey(t,f,c.iteration),g=await s.hmacSha256(m,"Client Key"),y=await s.sha256(g),b=await s.hmacSha256(y,p),w=(function(e,t){if(!Buffer.isBuffer(e))throw TypeError("first argument must be a Buffer");if(!Buffer.isBuffer(t))throw TypeError("second argument must be a Buffer");if(e.length!==t.length)throw Error("Buffer lengths must match");if(0===e.length)throw Error("Buffers cannot be empty");return Buffer.from(e.map((i,s)=>e[s]^t[s]))})(Buffer.from(g),Buffer.from(b)).toString("base64"),_=await s.hmacSha256(m,"Server Key"),E=await s.hmacSha256(_,p);e.message="SASLResponse",e.serverSignature=Buffer.from(E).toString("base64"),e.response=d+",p="+w},finalizeSession:function(e,t){if("SASLResponse"!==e.message)throw Error("SASL: Last message was not SASLResponse");if("string"!=typeof t)throw Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: serverData must be a string");let{serverSignature:i}=function(e){let t=a(e).get("v");if(t){if(!n(t))throw Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature must be base64")}else throw Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature is missing");return{serverSignature:t}}(t);if(i!==e.serverSignature)throw Error("SASL: SCRAM-SERVER-FINAL-MESSAGE: server signature does not match")}}},94163,(e,t,i)=>{"use strict";let s=e.r(85306);function r(e){this._types=e||s,this.text={},this.binary={}}r.prototype.getOverrides=function(e){switch(e){case"text":return this.text;case"binary":return this.binary;default:return{}}},r.prototype.setTypeParser=function(e,t,i){"function"==typeof t&&(i=t,t="text"),this.getOverrides(t)[e]=i},r.prototype.getTypeParser=function(e,t){return t=t||"text",this.getOverrides(t)[e]||this._types.getTypeParser(e,t)},t.exports=r},79594,(e,t,i)=>{t.exports=e.x("dns",()=>require("dns"))},17842,(e,t,i)=>{"use strict";function s(t,i={}){let r;if("/"===t.charAt(0)){let e=t.split(" ");return{host:e[0],database:e[1]}}let a={},o=!1;/ |%[^a-f0-9]|%[a-f0-9][^a-f0-9]/i.test(t)&&(t=encodeURI(t).replace(/%25(\d\d)/g,"%$1"));try{try{r=new URL(t,"postgres://base")}catch(e){r=new URL(t.replace("@/","@___DUMMY___/"),"postgres://base"),o=!0}}catch(e){throw e.input&&(e.input="*****REDACTED*****"),e}for(let e of r.searchParams.entries())a[e[0]]=e[1];if(a.user=a.user||decodeURIComponent(r.username),a.password=a.password||decodeURIComponent(r.password),"socket:"==r.protocol)return a.host=decodeURI(r.pathname),a.database=r.searchParams.get("db"),a.client_encoding=r.searchParams.get("encoding"),a;let c=o?"":r.hostname;a.host?c&&/^%2f/i.test(c)&&(r.pathname=c+r.pathname):a.host=decodeURIComponent(c),a.port||(a.port=r.port);let l=r.pathname.slice(1)||null;a.database=l?decodeURI(l):null,("true"===a.ssl||"1"===a.ssl)&&(a.ssl=!0),"0"===a.ssl&&(a.ssl=!1),(a.sslcert||a.sslkey||a.sslrootcert||a.sslmode)&&(a.ssl={});let h=a.sslcert||a.sslkey||a.sslrootcert?e.r(22734):null;if(a.sslcert&&(a.ssl.cert=h.readFileSync(a.sslcert).toString()),a.sslkey&&(a.ssl.key=h.readFileSync(a.sslkey).toString()),a.sslrootcert&&(a.ssl.ca=h.readFileSync(a.sslrootcert).toString()),i.useLibpqCompat&&a.uselibpqcompat)throw Error("Both useLibpqCompat and uselibpqcompat are set. Please use only one of them.");if("true"===a.uselibpqcompat||i.useLibpqCompat)switch(a.sslmode){case"disable":a.ssl=!1;break;case"prefer":a.ssl.rejectUnauthorized=!1;break;case"require":a.sslrootcert?a.ssl.checkServerIdentity=function(){}:a.ssl.rejectUnauthorized=!1;break;case"verify-ca":if(!a.ssl.ca)throw Error("SECURITY WARNING: Using sslmode=verify-ca requires specifying a CA with sslrootcert. If a public CA is used, verify-ca allows connections to a server that somebody else may have registered with the CA, making you vulnerable to Man-in-the-Middle attacks. Either specify a custom CA certificate with sslrootcert parameter or use sslmode=verify-full for proper security.");a.ssl.checkServerIdentity=function(){}}else switch(a.sslmode){case"disable":a.ssl=!1;break;case"prefer":case"require":case"verify-ca":case"verify-full":"verify-full"!==a.sslmode&&n(a.sslmode);break;case"no-verify":a.ssl.rejectUnauthorized=!1}return a}function r(e){return Object.entries(e).reduce((e,[t,i])=>{if("ssl"===t)"boolean"==typeof i&&(e[t]=i),"object"==typeof i&&(e[t]=Object.entries(i).reduce((e,[t,i])=>(null!=i&&(e[t]=i),e),{}));else if(null!=i)if("port"===t){if(""!==i){let s=parseInt(i,10);if(isNaN(s))throw Error(`Invalid ${t}: ${i}`);e[t]=s}}else e[t]=i;return e},{})}function n(e){!n.warned&&"undefined"!=typeof process&&process.emitWarning&&(n.warned=!0,process.emitWarning(`SECURITY WARNING: The SSL modes 'prefer', 'require', and 'verify-ca' are treated as aliases for 'verify-full'.
In the next major version (pg-connection-string v3.0.0 and pg v9.0.0), these modes will adopt standard libpq semantics, which have weaker security guarantees.

To prepare for this change:
- If you want the current behavior, explicitly use 'sslmode=verify-full'
- If you want libpq compatibility now, use 'uselibpqcompat=true&sslmode=${e}'

See https://www.postgresql.org/docs/current/libpq-ssl.html for libpq SSL mode definitions.`))}t.exports=s,s.parse=s,s.toClientConfig=r,s.parseIntoClientConfig=function(e){return r(s(e))}},38177,(e,t,i)=>{"use strict";let s=e.r(79594),r=e.r(91011),n=e.r(17842).parse,a=function(e,t,i){return t[e]?t[e]:(void 0===i?i=process.env["PG"+e.toUpperCase()]:!1===i||(i=process.env[i]),i||r[e])},o=function(){switch(process.env.PGSSLMODE){case"disable":return!1;case"prefer":case"require":case"verify-ca":case"verify-full":return!0;case"no-verify":return{rejectUnauthorized:!1}}return r.ssl},c=function(e){return"'"+(""+e).replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"},l=function(e,t,i){let s=t[i];null!=s&&e.push(i+"="+c(s))};t.exports=class{constructor(e){(e="string"==typeof e?n(e):e||{}).connectionString&&(e=Object.assign({},e,n(e.connectionString))),this.user=a("user",e),this.database=a("database",e),void 0===this.database&&(this.database=this.user),this.port=parseInt(a("port",e),10),this.host=a("host",e),Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:a("password",e)}),this.binary=a("binary",e),this.options=a("options",e),this.ssl=void 0===e.ssl?o():e.ssl,"string"==typeof this.ssl&&"true"===this.ssl&&(this.ssl=!0),"no-verify"===this.ssl&&(this.ssl={rejectUnauthorized:!1}),this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this.client_encoding=a("client_encoding",e),this.replication=a("replication",e),this.isDomainSocket=!(this.host||"").indexOf("/"),this.application_name=a("application_name",e,"PGAPPNAME"),this.fallback_application_name=a("fallback_application_name",e,!1),this.statement_timeout=a("statement_timeout",e,!1),this.lock_timeout=a("lock_timeout",e,!1),this.idle_in_transaction_session_timeout=a("idle_in_transaction_session_timeout",e,!1),this.query_timeout=a("query_timeout",e,!1),void 0===e.connectionTimeoutMillis?this.connect_timeout=process.env.PGCONNECT_TIMEOUT||0:this.connect_timeout=Math.floor(e.connectionTimeoutMillis/1e3),!1===e.keepAlive?this.keepalives=0:!0===e.keepAlive&&(this.keepalives=1),"number"==typeof e.keepAliveInitialDelayMillis&&(this.keepalives_idle=Math.floor(e.keepAliveInitialDelayMillis/1e3))}getLibpqConnectionString(e){let t=[];l(t,this,"user"),l(t,this,"password"),l(t,this,"port"),l(t,this,"application_name"),l(t,this,"fallback_application_name"),l(t,this,"connect_timeout"),l(t,this,"options");let i="object"==typeof this.ssl?this.ssl:this.ssl?{sslmode:this.ssl}:{};if(l(t,i,"sslmode"),l(t,i,"sslca"),l(t,i,"sslkey"),l(t,i,"sslcert"),l(t,i,"sslrootcert"),this.database&&t.push("dbname="+c(this.database)),this.replication&&t.push("replication="+c(this.replication)),this.host&&t.push("host="+c(this.host)),this.isDomainSocket)return e(null,t.join(" "));this.client_encoding&&t.push("client_encoding="+c(this.client_encoding)),s.lookup(this.host,function(i,s){return i?e(i,null):(t.push("hostaddr="+c(s)),e(null,t.join(" ")))})}}},88851,(e,t,i)=>{"use strict";let s=e.r(85306),r=/^([A-Za-z]+)(?: (\d+))?(?: (\d+))?/;t.exports=class{constructor(e,t){this.command=null,this.rowCount=null,this.oid=null,this.rows=[],this.fields=[],this._parsers=void 0,this._types=t,this.RowCtor=null,this.rowAsArray="array"===e,this.rowAsArray&&(this.parseRow=this._parseRowAsArray),this._prebuiltEmptyResultObject=null}addCommandComplete(e){let t;(t=e.text?r.exec(e.text):r.exec(e.command))&&(this.command=t[1],t[3]?(this.oid=parseInt(t[2],10),this.rowCount=parseInt(t[3],10)):t[2]&&(this.rowCount=parseInt(t[2],10)))}_parseRowAsArray(e){let t=Array(e.length);for(let i=0,s=e.length;i<s;i++){let s=e[i];null!==s?t[i]=this._parsers[i](s):t[i]=null}return t}parseRow(e){let t={...this._prebuiltEmptyResultObject};for(let i=0,s=e.length;i<s;i++){let s=e[i],r=this.fields[i].name;if(null!==s){let e="binary"===this.fields[i].format?Buffer.from(s):s;t[r]=this._parsers[i](e)}else t[r]=null}return t}addRow(e){this.rows.push(e)}addFields(e){this.fields=e,this.fields.length&&(this._parsers=Array(e.length));let t={};for(let i=0;i<e.length;i++){let r=e[i];t[r.name]=null,this._types?this._parsers[i]=this._types.getTypeParser(r.dataTypeID,r.format||"text"):this._parsers[i]=s.getTypeParser(r.dataTypeID,r.format||"text")}this._prebuiltEmptyResultObject={...t}}}},73760,(e,t,i)=>{"use strict";let{EventEmitter:s}=e.r(27699),r=e.r(88851),n=e.r(78076);t.exports=class extends s{constructor(e,t,i){super(),e=n.normalizeQueryConfig(e,t,i),this.text=e.text,this.values=e.values,this.rows=e.rows,this.types=e.types,this.name=e.name,this.queryMode=e.queryMode,this.binary=e.binary,this.portal=e.portal||"",this.callback=e.callback,this._rowMode=e.rowMode,process.domain&&e.callback&&(this.callback=process.domain.bind(e.callback)),this._result=new r(this._rowMode,this.types),this._results=this._result,this._canceledDueToError=!1}requiresPreparation(){return"extended"===this.queryMode||!!this.name||!!this.rows||!!this.text&&!!this.values&&this.values.length>0}_checkForMultirow(){this._result.command&&(Array.isArray(this._results)||(this._results=[this._result]),this._result=new r(this._rowMode,this._result._types),this._results.push(this._result))}handleRowDescription(e){this._checkForMultirow(),this._result.addFields(e.fields),this._accumulateRows=this.callback||!this.listeners("row").length}handleDataRow(e){let t;if(!this._canceledDueToError){try{t=this._result.parseRow(e.fields)}catch(e){this._canceledDueToError=e;return}this.emit("row",t,this._result),this._accumulateRows&&this._result.addRow(t)}}handleCommandComplete(e,t){this._checkForMultirow(),this._result.addCommandComplete(e),this.rows&&t.sync()}handleEmptyQuery(e){this.rows&&e.sync()}handleError(e,t){if(this._canceledDueToError&&(e=this._canceledDueToError,this._canceledDueToError=!1),this.callback)return this.callback(e);this.emit("error",e)}handleReadyForQuery(e){if(this._canceledDueToError)return this.handleError(this._canceledDueToError,e);if(this.callback)try{this.callback(null,this._results)}catch(e){process.nextTick(()=>{throw e})}this.emit("end",this._results)}submit(e){if("string"!=typeof this.text&&"string"!=typeof this.name)return Error("A query must have either text or a name. Supplying neither is unsupported.");let t=e.parsedStatements[this.name];if(this.text&&t&&this.text!==t)return Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);if(this.values&&!Array.isArray(this.values))return Error("Query values must be an array");if(this.requiresPreparation()){e.stream.cork&&e.stream.cork();try{this.prepare(e)}finally{e.stream.uncork&&e.stream.uncork()}}else e.query(this.text);return null}hasBeenParsed(e){return this.name&&e.parsedStatements[this.name]}handlePortalSuspended(e){this._getRows(e,this.rows)}_getRows(e,t){e.execute({portal:this.portal,rows:t}),t?e.flush():e.sync()}prepare(e){this.hasBeenParsed(e)||e.parse({text:this.text,name:this.name,types:this.types});try{e.bind({portal:this.portal,statement:this.name,values:this.values,binary:this.binary,valueMapper:n.prepareValue})}catch(t){this.handleError(t,e);return}e.describe({type:"P",name:this.portal||""}),this._getRows(e,this.rows)}handleCopyInResponse(e){e.sendCopyFail("No source stream defined")}handleCopyData(e,t){}}},62617,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.NoticeMessage=i.DataRowMessage=i.CommandCompleteMessage=i.ReadyForQueryMessage=i.NotificationResponseMessage=i.BackendKeyDataMessage=i.AuthenticationMD5Password=i.ParameterStatusMessage=i.ParameterDescriptionMessage=i.RowDescriptionMessage=i.Field=i.CopyResponse=i.CopyDataMessage=i.DatabaseError=i.copyDone=i.emptyQuery=i.replicationStart=i.portalSuspended=i.noData=i.closeComplete=i.bindComplete=i.parseComplete=void 0,i.parseComplete={name:"parseComplete",length:5},i.bindComplete={name:"bindComplete",length:5},i.closeComplete={name:"closeComplete",length:5},i.noData={name:"noData",length:5},i.portalSuspended={name:"portalSuspended",length:5},i.replicationStart={name:"replicationStart",length:4},i.emptyQuery={name:"emptyQuery",length:4},i.copyDone={name:"copyDone",length:4},i.DatabaseError=class extends Error{constructor(e,t,i){super(e),this.length=t,this.name=i}},i.CopyDataMessage=class{constructor(e,t){this.length=e,this.chunk=t,this.name="copyData"}},i.CopyResponse=class{constructor(e,t,i,s){this.length=e,this.name=t,this.binary=i,this.columnTypes=Array(s)}},i.Field=class{constructor(e,t,i,s,r,n,a){this.name=e,this.tableID=t,this.columnID=i,this.dataTypeID=s,this.dataTypeSize=r,this.dataTypeModifier=n,this.format=a}},i.RowDescriptionMessage=class{constructor(e,t){this.length=e,this.fieldCount=t,this.name="rowDescription",this.fields=Array(this.fieldCount)}},i.ParameterDescriptionMessage=class{constructor(e,t){this.length=e,this.parameterCount=t,this.name="parameterDescription",this.dataTypeIDs=Array(this.parameterCount)}},i.ParameterStatusMessage=class{constructor(e,t,i){this.length=e,this.parameterName=t,this.parameterValue=i,this.name="parameterStatus"}},i.AuthenticationMD5Password=class{constructor(e,t){this.length=e,this.salt=t,this.name="authenticationMD5Password"}},i.BackendKeyDataMessage=class{constructor(e,t,i){this.length=e,this.processID=t,this.secretKey=i,this.name="backendKeyData"}},i.NotificationResponseMessage=class{constructor(e,t,i,s){this.length=e,this.processId=t,this.channel=i,this.payload=s,this.name="notification"}},i.ReadyForQueryMessage=class{constructor(e,t){this.length=e,this.status=t,this.name="readyForQuery"}},i.CommandCompleteMessage=class{constructor(e,t){this.length=e,this.text=t,this.name="commandComplete"}},i.DataRowMessage=class{constructor(e,t){this.length=e,this.fields=t,this.name="dataRow",this.fieldCount=t.length}},i.NoticeMessage=class{constructor(e,t){this.length=e,this.message=t,this.name="notice"}}},7487,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.Writer=void 0,i.Writer=class{constructor(e=256){this.size=e,this.offset=5,this.headerPosition=0,this.buffer=Buffer.allocUnsafe(e)}ensure(e){if(this.buffer.length-this.offset<e){let t=this.buffer,i=t.length+(t.length>>1)+e;this.buffer=Buffer.allocUnsafe(i),t.copy(this.buffer)}}addInt32(e){return this.ensure(4),this.buffer[this.offset++]=e>>>24&255,this.buffer[this.offset++]=e>>>16&255,this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addInt16(e){return this.ensure(2),this.buffer[this.offset++]=e>>>8&255,this.buffer[this.offset++]=e>>>0&255,this}addCString(e){if(e){let t=Buffer.byteLength(e);this.ensure(t+1),this.buffer.write(e,this.offset,"utf-8"),this.offset+=t}else this.ensure(1);return this.buffer[this.offset++]=0,this}addString(e=""){let t=Buffer.byteLength(e);return this.ensure(t),this.buffer.write(e,this.offset),this.offset+=t,this}add(e){return this.ensure(e.length),e.copy(this.buffer,this.offset),this.offset+=e.length,this}join(e){if(e){this.buffer[this.headerPosition]=e;let t=this.offset-(this.headerPosition+1);this.buffer.writeInt32BE(t,this.headerPosition+1)}return this.buffer.slice(5*!e,this.offset)}flush(e){let t=this.join(e);return this.offset=5,this.headerPosition=0,this.buffer=Buffer.allocUnsafe(this.size),t}}},3425,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.serialize=void 0;let s=e.r(7487),r=new s.Writer,n=[],a=new s.Writer,o=function(e,t){for(let i=0;i<e.length;i++){let s=t?t(e[i],i):e[i];null==s?(r.addInt16(0),a.addInt32(-1)):s instanceof Buffer?(r.addInt16(1),a.addInt32(s.length),a.add(s)):(r.addInt16(0),a.addInt32(Buffer.byteLength(s)),a.addString(s))}},c=Buffer.from([69,0,0,0,9,0,0,0,0,0]),l=(e,t)=>{let i=4+Buffer.byteLength(t)+1,s=Buffer.allocUnsafe(1+i);return s[0]=e,s.writeInt32BE(i,1),s.write(t,5,"utf-8"),s[i]=0,s},h=r.addCString("P").flush(68),u=r.addCString("S").flush(68),d=e=>Buffer.from([e,0,0,0,4]),p=d(72),f=d(83),m=d(88),g=d(99);i.serialize={startup:e=>{for(let t of(r.addInt16(3).addInt16(0),Object.keys(e)))r.addCString(t).addCString(e[t]);r.addCString("client_encoding").addCString("UTF8");let t=r.addCString("").flush(),i=t.length+4;return new s.Writer().addInt32(i).add(t).flush()},password:e=>r.addCString(e).flush(112),requestSsl:()=>{let e=Buffer.allocUnsafe(8);return e.writeInt32BE(8,0),e.writeInt32BE(0x4d2162f,4),e},sendSASLInitialResponseMessage:function(e,t){return r.addCString(e).addInt32(Buffer.byteLength(t)).addString(t),r.flush(112)},sendSCRAMClientFinalMessage:function(e){return r.addString(e).flush(112)},query:e=>r.addCString(e).flush(81),parse:e=>{let t=e.name||"";t.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",t,t.length),console.error("This can cause conflicts and silent errors executing queries"));let i=e.types||n,s=i.length,a=r.addCString(t).addCString(e.text).addInt16(s);for(let e=0;e<s;e++)a.addInt32(i[e]);return r.flush(80)},bind:(e={})=>{let t=e.portal||"",i=e.statement||"",s=e.binary||!1,c=e.values||n,l=c.length;return r.addCString(t).addCString(i),r.addInt16(l),o(c,e.valueMapper),r.addInt16(l),r.add(a.flush()),r.addInt16(1),r.addInt16(+!!s),r.flush(66)},execute:e=>{if(!e||!e.portal&&!e.rows)return c;let t=e.portal||"",i=e.rows||0,s=Buffer.byteLength(t),r=4+s+1+4,n=Buffer.allocUnsafe(1+r);return n[0]=69,n.writeInt32BE(r,1),n.write(t,5,"utf-8"),n[s+5]=0,n.writeUInt32BE(i,n.length-4),n},describe:e=>e.name?l(68,`${e.type}${e.name||""}`):"P"===e.type?h:u,close:e=>l(67,`${e.type}${e.name||""}`),flush:()=>p,sync:()=>f,end:()=>m,copyData:e=>r.add(e).flush(100),copyDone:()=>g,copyFail:e=>l(102,e),cancel:(e,t)=>{let i=Buffer.allocUnsafe(16);return i.writeInt32BE(16,0),i.writeInt16BE(1234,4),i.writeInt16BE(5678,6),i.writeInt32BE(e,8),i.writeInt32BE(t,12),i}}},65590,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.BufferReader=void 0;let s=Buffer.allocUnsafe(0);i.BufferReader=class{constructor(e=0){this.offset=e,this.buffer=s,this.encoding="utf-8"}setBuffer(e,t){this.offset=e,this.buffer=t}int16(){let e=this.buffer.readInt16BE(this.offset);return this.offset+=2,e}byte(){let e=this.buffer[this.offset];return this.offset++,e}int32(){let e=this.buffer.readInt32BE(this.offset);return this.offset+=4,e}uint32(){let e=this.buffer.readUInt32BE(this.offset);return this.offset+=4,e}string(e){let t=this.buffer.toString(this.encoding,this.offset,this.offset+e);return this.offset+=e,t}cstring(){let e=this.offset,t=e;for(;0!==this.buffer[t++];);return this.offset=t,this.buffer.toString(this.encoding,e,t-1)}bytes(e){let t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}}},28673,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.Parser=void 0;let s=e.r(62617),r=e.r(65590),n=Buffer.allocUnsafe(0);i.Parser=class{constructor(e){if(this.buffer=n,this.bufferLength=0,this.bufferOffset=0,this.reader=new r.BufferReader,(null==e?void 0:e.mode)==="binary")throw Error("Binary mode not supported yet");this.mode=(null==e?void 0:e.mode)||"text"}parse(e,t){this.mergeBuffer(e);let i=this.bufferOffset+this.bufferLength,s=this.bufferOffset;for(;s+5<=i;){let e=this.buffer[s],r=this.buffer.readUInt32BE(s+1),n=1+r;if(n+s<=i)t(this.handlePacket(s+5,e,r,this.buffer)),s+=n;else break}s===i?(this.buffer=n,this.bufferLength=0,this.bufferOffset=0):(this.bufferLength=i-s,this.bufferOffset=s)}mergeBuffer(e){if(this.bufferLength>0){let t=this.bufferLength+e.byteLength;if(t+this.bufferOffset>this.buffer.byteLength){let e;if(t<=this.buffer.byteLength&&this.bufferOffset>=this.bufferLength)e=this.buffer;else{let i=2*this.buffer.byteLength;for(;t>=i;)i*=2;e=Buffer.allocUnsafe(i)}this.buffer.copy(e,0,this.bufferOffset,this.bufferOffset+this.bufferLength),this.buffer=e,this.bufferOffset=0}e.copy(this.buffer,this.bufferOffset+this.bufferLength),this.bufferLength=t}else this.buffer=e,this.bufferOffset=0,this.bufferLength=e.byteLength}handlePacket(e,t,i,r){let u,{reader:f}=this;switch(f.setBuffer(e,r),t){case 50:u=s.bindComplete;break;case 49:u=s.parseComplete;break;case 51:u=s.closeComplete;break;case 110:u=s.noData;break;case 115:u=s.portalSuspended;break;case 99:u=s.copyDone;break;case 87:u=s.replicationStart;break;case 73:u=s.emptyQuery;break;case 68:u=g(f);break;case 67:u=o(f);break;case 90:u=a(f);break;case 65:u=d(f);break;case 82:u=w(f,i);break;case 83:u=y(f);break;case 75:u=b(f);break;case 69:u=_(f,"error");break;case 78:u=_(f,"notice");break;case 84:u=p(f);break;case 116:u=m(f);break;case 71:u=l(f);break;case 72:u=h(f);break;case 100:u=c(f,i);break;default:return new s.DatabaseError("received invalid response: "+t.toString(16),i,"error")}return f.setBuffer(0,n),u.length=i,u}};let a=e=>{let t=e.string(1);return new s.ReadyForQueryMessage(-1,t)},o=e=>{let t=e.cstring();return new s.CommandCompleteMessage(-1,t)},c=(e,t)=>{let i=e.bytes(t-4);return new s.CopyDataMessage(-1,i)},l=e=>u(e,"copyInResponse"),h=e=>u(e,"copyOutResponse"),u=(e,t)=>{let i=0!==e.byte(),r=e.int16(),n=new s.CopyResponse(-1,t,i,r);for(let t=0;t<r;t++)n.columnTypes[t]=e.int16();return n},d=e=>{let t=e.int32(),i=e.cstring(),r=e.cstring();return new s.NotificationResponseMessage(-1,t,i,r)},p=e=>{let t=e.int16(),i=new s.RowDescriptionMessage(-1,t);for(let s=0;s<t;s++)i.fields[s]=f(e);return i},f=e=>{let t=e.cstring(),i=e.uint32(),r=e.int16(),n=e.uint32(),a=e.int16(),o=e.int32(),c=0===e.int16()?"text":"binary";return new s.Field(t,i,r,n,a,o,c)},m=e=>{let t=e.int16(),i=new s.ParameterDescriptionMessage(-1,t);for(let s=0;s<t;s++)i.dataTypeIDs[s]=e.int32();return i},g=e=>{let t=e.int16(),i=Array(t);for(let s=0;s<t;s++){let t=e.int32();i[s]=-1===t?null:e.string(t)}return new s.DataRowMessage(-1,i)},y=e=>{let t=e.cstring(),i=e.cstring();return new s.ParameterStatusMessage(-1,t,i)},b=e=>{let t=e.int32(),i=e.int32();return new s.BackendKeyDataMessage(-1,t,i)},w=(e,t)=>{let i=e.int32(),r={name:"authenticationOk",length:t};switch(i){case 0:break;case 3:8===r.length&&(r.name="authenticationCleartextPassword");break;case 5:if(12===r.length){r.name="authenticationMD5Password";let t=e.bytes(4);return new s.AuthenticationMD5Password(-1,t)}break;case 10:{let t;r.name="authenticationSASL",r.mechanisms=[];do(t=e.cstring())&&r.mechanisms.push(t);while(t)}break;case 11:r.name="authenticationSASLContinue",r.data=e.string(t-8);break;case 12:r.name="authenticationSASLFinal",r.data=e.string(t-8);break;default:throw Error("Unknown authenticationOk message type "+i)}return r},_=(e,t)=>{let i={},r=e.string(1);for(;"\0"!==r;)i[r]=e.cstring(),r=e.string(1);let n=i.M,a="notice"===t?new s.NoticeMessage(-1,n):new s.DatabaseError(n,-1,t);return a.severity=i.S,a.code=i.C,a.detail=i.D,a.hint=i.H,a.position=i.P,a.internalPosition=i.p,a.internalQuery=i.q,a.where=i.W,a.schema=i.s,a.table=i.t,a.column=i.c,a.dataType=i.d,a.constraint=i.n,a.file=i.F,a.line=i.L,a.routine=i.R,a}},86833,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.DatabaseError=i.serialize=i.parse=void 0;let s=e.r(62617);Object.defineProperty(i,"DatabaseError",{enumerable:!0,get:function(){return s.DatabaseError}});let r=e.r(3425);Object.defineProperty(i,"serialize",{enumerable:!0,get:function(){return r.serialize}});let n=e.r(28673);i.parse=function(e,t){let i=new n.Parser;return e.on("data",e=>i.parse(e,t)),new Promise(t=>e.on("end",()=>t()))}},4446,(e,t,i)=>{t.exports=e.x("net",()=>require("net"))},55004,(e,t,i)=>{t.exports=e.x("tls",()=>require("tls"))},73247,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.default={}},4410,(e,t,i)=>{let{getStream:s,getSecureStream:r}=!function(){if("object"==typeof navigator&&null!==navigator&&"string"==typeof navigator.userAgent)return"Cloudflare-Workers"===navigator.userAgent;if("function"==typeof Response){let e=new Response(null,{cf:{thing:!0}});if("object"==typeof e.cf&&null!==e.cf&&e.cf.thing)return!0}return!1}()?{getStream:function(t){return new(e.r(4446)).Socket},getSecureStream:function(t){return e.r(55004).connect(t)}}:{getStream:function(t){let{CloudflareSocket:i}=e.r(73247);return new i(t)},getSecureStream:function(e){return e.socket.startTls(e),e.socket}};t.exports={getStream:s,getSecureStream:r}},29760,(e,t,i)=>{"use strict";let s=e.r(27699).EventEmitter,{parse:r,serialize:n}=e.r(86833),{getStream:a,getSecureStream:o}=e.r(4410),c=n.flush(),l=n.sync(),h=n.end();t.exports=class extends s{constructor(e){super(),e=e||{},this.stream=e.stream||a(e.ssl),"function"==typeof this.stream&&(this.stream=this.stream(e)),this._keepAlive=e.keepAlive,this._keepAliveInitialDelayMillis=e.keepAliveInitialDelayMillis,this.parsedStatements={},this.ssl=e.ssl||!1,this._ending=!1,this._emitMessage=!1;const t=this;this.on("newListener",function(e){"message"===e&&(t._emitMessage=!0)})}connect(t,i){let s=this;this._connecting=!0,this.stream.setNoDelay(!0),this.stream.connect(t,i),this.stream.once("connect",function(){s._keepAlive&&s.stream.setKeepAlive(!0,s._keepAliveInitialDelayMillis),s.emit("connect")});let r=function(e){s._ending&&("ECONNRESET"===e.code||"EPIPE"===e.code)||s.emit("error",e)};if(this.stream.on("error",r),this.stream.on("close",function(){s.emit("end")}),!this.ssl)return this.attachListeners(this.stream);this.stream.once("data",function(t){switch(t.toString("utf8")){case"S":break;case"N":return s.stream.end(),s.emit("error",Error("The server does not support SSL connections"));default:return s.stream.end(),s.emit("error",Error("There was an error establishing an SSL connection"))}let n={socket:s.stream};!0!==s.ssl&&(Object.assign(n,s.ssl),"key"in s.ssl&&(n.key=s.ssl.key));let a=e.r(4446);a.isIP&&0===a.isIP(i)&&(n.servername=i);try{s.stream=o(n)}catch(e){return s.emit("error",e)}s.attachListeners(s.stream),s.stream.on("error",r),s.emit("sslconnect")})}attachListeners(e){r(e,e=>{let t="error"===e.name?"errorMessage":e.name;this._emitMessage&&this.emit("message",e),this.emit(t,e)})}requestSsl(){this.stream.write(n.requestSsl())}startup(e){this.stream.write(n.startup(e))}cancel(e,t){this._send(n.cancel(e,t))}password(e){this._send(n.password(e))}sendSASLInitialResponseMessage(e,t){this._send(n.sendSASLInitialResponseMessage(e,t))}sendSCRAMClientFinalMessage(e){this._send(n.sendSCRAMClientFinalMessage(e))}_send(e){return!!this.stream.writable&&this.stream.write(e)}query(e){this._send(n.query(e))}parse(e){this._send(n.parse(e))}bind(e){this._send(n.bind(e))}execute(e){this._send(n.execute(e))}flush(){this.stream.writable&&this.stream.write(c)}sync(){this._ending=!0,this._send(l)}ref(){this.stream.ref()}unref(){this.stream.unref()}end(){return(this._ending=!0,this._connecting&&this.stream.writable)?this.stream.write(h,()=>{this.stream.end()}):void this.stream.end()}close(e){this._send(n.close(e))}describe(e){this._send(n.describe(e))}sendCopyFromChunk(e){this._send(n.copyData(e))}endCopyFrom(){this._send(n.copyDone())}sendCopyFail(e){this._send(n.copyFail(e))}}},88947,(e,t,i)=>{t.exports=e.x("stream",()=>require("stream"))},99348,(e,t,i)=>{t.exports=e.x("string_decoder",()=>require("string_decoder"))},10802,(e,t,i)=>{"use strict";let{Transform:s}=e.r(88947),{StringDecoder:r}=e.r(99348),n=Symbol("last"),a=Symbol("decoder");function o(e,t,i){let s;if(this.overflow){if(1===(s=this[a].write(e).split(this.matcher)).length)return i();s.shift(),this.overflow=!1}else this[n]+=this[a].write(e),s=this[n].split(this.matcher);this[n]=s.pop();for(let e=0;e<s.length;e++)try{l(this,this.mapper(s[e]))}catch(e){return i(e)}(this.overflow=this[n].length>this.maxLength,this.overflow&&!this.skipOverflow)?i(Error("maximum buffer reached")):i()}function c(e){if(this[n]+=this[a].end(),this[n])try{l(this,this.mapper(this[n]))}catch(t){return e(t)}e()}function l(e,t){void 0!==t&&e.push(t)}function h(e){return e}t.exports=function(e,t,i){switch(e=e||/\r?\n/,t=t||h,i=i||{},arguments.length){case 1:"function"==typeof e?(t=e,e=/\r?\n/):"object"!=typeof e||e instanceof RegExp||e[Symbol.split]||(i=e,e=/\r?\n/);break;case 2:"function"==typeof e?(i=t,t=e,e=/\r?\n/):"object"==typeof t&&(i=t,t=h)}(i=Object.assign({},i)).autoDestroy=!0,i.transform=o,i.flush=c,i.readableObjectMode=!0;let l=new s(i);return l[n]="",l[a]=new r("utf8"),l.matcher=e,l.mapper=t,l.maxLength=i.maxLength,l.skipOverflow=i.skipOverflow||!1,l.overflow=!1,l._destroy=function(e,t){this._writableState.errorEmitted=!1,t(e)},l}},99176,(e,t,i)=>{"use strict";var s=e.r(14747),r=e.r(88947).Stream,n=e.r(10802),a=e.r(24361),o="win32"===process.platform,c=process.stderr,l=["host","port","database","user","password"],h=l.length,u=l[h-1];function d(){if(c instanceof r&&!0===c.writable){var e=Array.prototype.slice.call(arguments).concat("\n");c.write(a.format.apply(a,e))}}Object.defineProperty(t.exports,"isWin",{get:function(){return o},set:function(e){o=e}}),t.exports.warnTo=function(e){var t=c;return c=e,t},t.exports.getFileName=function(e){var t=e||process.env;return t.PGPASSFILE||(o?s.join(t.APPDATA||"./","postgresql","pgpass.conf"):s.join(t.HOME||"./",".pgpass"))},t.exports.usePgPass=function(e,t){return!Object.prototype.hasOwnProperty.call(process.env,"PGPASSWORD")&&(!!o||((t=t||"<unkn>",(61440&e.mode)!=32768)?(d('WARNING: password file "%s" is not a plain file',t),!1):!(63&e.mode)||(d('WARNING: password file "%s" has group or world access; permissions should be u=rw (0600) or less',t),!1)))};var p=t.exports.match=function(e,t){return l.slice(0,-1).reduce(function(i,s,r){return 1==r&&Number(e[s]||5432)===Number(t[s])?i&&!0:i&&("*"===t[s]||t[s]===e[s])},!0)};t.exports.getPassword=function(e,t,i){var s,r=t.pipe(n()),a=function(e){t.destroy(),d("WARNING: error on reading file: %s",e),i(void 0)};t.on("error",a),r.on("data",function(t){var i=f(t);i&&m(i)&&p(e,i)&&(s=i[u],r.end())}).on("end",function(){t.destroy(),i(s)}).on("error",a)};var f=t.exports.parseLine=function(e){if(e.length<11||e.match(/^\s+#/))return null;for(var t="",i="",s=0,r=0,n={},a=!1,o=function(t,i,s){var r=e.substring(i,s);Object.hasOwnProperty.call(process.env,"PGPASS_NO_DEESCAPE")||(r=r.replace(/\\([:\\])/g,"$1")),n[l[t]]=r},c=0;c<e.length-1;c+=1){if(t=e.charAt(c+1),i=e.charAt(c),s==h-1){o(s,r);break}c>=0&&":"==t&&"\\"!==i&&(o(s,r,c+1),r=c+2,s+=1)}return n=Object.keys(n).length===h?n:null},m=t.exports.isValidEntry=function(e){for(var t={0:function(e){return e.length>0},1:function(e){return"*"===e||isFinite(e=Number(e))&&e>0&&e<0x20000000000000&&Math.floor(e)===e},2:function(e){return e.length>0},3:function(e){return e.length>0},4:function(e){return e.length>0}},i=0;i<l.length;i+=1)if(!(0,t[i])(e[l[i]]||""))return!1;return!0}},22742,(e,t,i)=>{"use strict";e.r(14747);var s=e.r(22734),r=e.r(99176);t.exports=function(e,t){var i=r.getFileName();s.stat(i,function(n,a){if(n||!r.usePgPass(a,i))return t(void 0);var o=s.createReadStream(i);r.getPassword(e,o,t)})},t.exports.warnTo=r.warnTo},4448,(e,t,i)=>{"use strict";let s=e.r(27699).EventEmitter,r=e.r(78076),n=e.r(24361),a=e.r(45978),o=e.r(94163),c=e.r(38177),l=e.r(73760),h=e.r(91011),u=e.r(29760),d=e.r(73265),p=n.deprecate(()=>{},"Client.activeQuery is deprecated and will be removed in a future version."),f=n.deprecate(()=>{},"Client.queryQueue is deprecated and will be removed in a future version."),m=n.deprecate(()=>{},"pgpass support is deprecated and will be removed in a future version. You can provide an async function as the password property to the Client/Pool constructor that returns a password instead. Within this funciton you can call the pgpass module in your own code."),g=n.deprecate(()=>{},"Passing a custom Promise implementation to the Client/Pool constructor is deprecated and will be removed in a future version.");class y extends s{constructor(t){super(),this.connectionParameters=new c(t),this.user=this.connectionParameters.user,this.database=this.connectionParameters.database,this.port=this.connectionParameters.port,this.host=this.connectionParameters.host,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:this.connectionParameters.password}),this.replication=this.connectionParameters.replication;const i=t||{};i.Promise&&g(),this._Promise=i.Promise||e.g.Promise,this._types=new o(i.types),this._ending=!1,this._ended=!1,this._connecting=!1,this._connected=!1,this._connectionError=!1,this._queryable=!0,this._activeQuery=null,this.enableChannelBinding=!!i.enableChannelBinding,this.connection=i.connection||new u({stream:i.stream,ssl:this.connectionParameters.ssl,keepAlive:i.keepAlive||!1,keepAliveInitialDelayMillis:i.keepAliveInitialDelayMillis||0,encoding:this.connectionParameters.client_encoding||"utf8"}),this._queryQueue=[],this.binary=i.binary||h.binary,this.processID=null,this.secretKey=null,this.ssl=this.connectionParameters.ssl||!1,this.ssl&&this.ssl.key&&Object.defineProperty(this.ssl,"key",{enumerable:!1}),this._connectionTimeoutMillis=i.connectionTimeoutMillis||0}get activeQuery(){return p(),this._activeQuery}set activeQuery(e){p(),this._activeQuery=e}_getActiveQuery(){return this._activeQuery}_errorAllQueries(e){let t=t=>{process.nextTick(()=>{t.handleError(e,this.connection)})},i=this._getActiveQuery();i&&(t(i),this._activeQuery=null),this._queryQueue.forEach(t),this._queryQueue.length=0}_connect(e){let t=this,i=this.connection;if(this._connectionCallback=e,this._connecting||this._connected){let t=Error("Client has already been connected. You cannot reuse a client.");process.nextTick(()=>{e(t)});return}this._connecting=!0,this._connectionTimeoutMillis>0&&(this.connectionTimeoutHandle=setTimeout(()=>{i._ending=!0,i.stream.destroy(Error("timeout expired"))},this._connectionTimeoutMillis),this.connectionTimeoutHandle.unref&&this.connectionTimeoutHandle.unref()),this.host&&0===this.host.indexOf("/")?i.connect(this.host+"/.s.PGSQL."+this.port):i.connect(this.port,this.host),i.on("connect",function(){t.ssl?i.requestSsl():i.startup(t.getStartupConf())}),i.on("sslconnect",function(){i.startup(t.getStartupConf())}),this._attachListeners(i),i.once("end",()=>{let e=this._ending?Error("Connection terminated"):Error("Connection terminated unexpectedly");clearTimeout(this.connectionTimeoutHandle),this._errorAllQueries(e),this._ended=!0,!this._ending&&(this._connecting&&!this._connectionError?this._connectionCallback?this._connectionCallback(e):this._handleErrorEvent(e):this._connectionError||this._handleErrorEvent(e)),process.nextTick(()=>{this.emit("end")})})}connect(e){return e?void this._connect(e):new this._Promise((e,t)=>{this._connect(i=>{i?t(i):e(this)})})}_attachListeners(e){e.on("authenticationCleartextPassword",this._handleAuthCleartextPassword.bind(this)),e.on("authenticationMD5Password",this._handleAuthMD5Password.bind(this)),e.on("authenticationSASL",this._handleAuthSASL.bind(this)),e.on("authenticationSASLContinue",this._handleAuthSASLContinue.bind(this)),e.on("authenticationSASLFinal",this._handleAuthSASLFinal.bind(this)),e.on("backendKeyData",this._handleBackendKeyData.bind(this)),e.on("error",this._handleErrorEvent.bind(this)),e.on("errorMessage",this._handleErrorMessage.bind(this)),e.on("readyForQuery",this._handleReadyForQuery.bind(this)),e.on("notice",this._handleNotice.bind(this)),e.on("rowDescription",this._handleRowDescription.bind(this)),e.on("dataRow",this._handleDataRow.bind(this)),e.on("portalSuspended",this._handlePortalSuspended.bind(this)),e.on("emptyQuery",this._handleEmptyQuery.bind(this)),e.on("commandComplete",this._handleCommandComplete.bind(this)),e.on("parseComplete",this._handleParseComplete.bind(this)),e.on("copyInResponse",this._handleCopyInResponse.bind(this)),e.on("copyData",this._handleCopyData.bind(this)),e.on("notification",this._handleNotification.bind(this))}_getPassword(t){let i=this.connection;if("function"==typeof this.password)this._Promise.resolve().then(()=>this.password()).then(e=>{if(void 0!==e){if("string"!=typeof e)return void i.emit("error",TypeError("Password must be a string"));this.connectionParameters.password=this.password=e}else this.connectionParameters.password=this.password=null;t()}).catch(e=>{i.emit("error",e)});else if(null!==this.password)t();else try{e.r(22742)(this.connectionParameters,e=>{void 0!==e&&(m(),this.connectionParameters.password=this.password=e),t()})}catch(e){this.emit("error",e)}}_handleAuthCleartextPassword(e){this._getPassword(()=>{this.connection.password(this.password)})}_handleAuthMD5Password(e){this._getPassword(async()=>{try{let t=await d.postgresMd5PasswordHash(this.user,this.password,e.salt);this.connection.password(t)}catch(e){this.emit("error",e)}})}_handleAuthSASL(e){this._getPassword(()=>{try{this.saslSession=a.startSession(e.mechanisms,this.enableChannelBinding&&this.connection.stream),this.connection.sendSASLInitialResponseMessage(this.saslSession.mechanism,this.saslSession.response)}catch(e){this.connection.emit("error",e)}})}async _handleAuthSASLContinue(e){try{await a.continueSession(this.saslSession,this.password,e.data,this.enableChannelBinding&&this.connection.stream),this.connection.sendSCRAMClientFinalMessage(this.saslSession.response)}catch(e){this.connection.emit("error",e)}}_handleAuthSASLFinal(e){try{a.finalizeSession(this.saslSession,e.data),this.saslSession=null}catch(e){this.connection.emit("error",e)}}_handleBackendKeyData(e){this.processID=e.processID,this.secretKey=e.secretKey}_handleReadyForQuery(e){this._connecting&&(this._connecting=!1,this._connected=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback&&(this._connectionCallback(null,this),this._connectionCallback=null),this.emit("connect"));let t=this._getActiveQuery();this._activeQuery=null,this.readyForQuery=!0,t&&t.handleReadyForQuery(this.connection),this._pulseQueryQueue()}_handleErrorWhileConnecting(e){if(!this._connectionError){if(this._connectionError=!0,clearTimeout(this.connectionTimeoutHandle),this._connectionCallback)return this._connectionCallback(e);this.emit("error",e)}}_handleErrorEvent(e){if(this._connecting)return this._handleErrorWhileConnecting(e);this._queryable=!1,this._errorAllQueries(e),this.emit("error",e)}_handleErrorMessage(e){if(this._connecting)return this._handleErrorWhileConnecting(e);let t=this._getActiveQuery();t?(this._activeQuery=null,t.handleError(e,this.connection)):this._handleErrorEvent(e)}_handleRowDescription(e){let t=this._getActiveQuery();if(null==t){let e=Error("Received unexpected rowDescription message from backend.");this._handleErrorEvent(e);return}t.handleRowDescription(e)}_handleDataRow(e){let t=this._getActiveQuery();if(null==t){let e=Error("Received unexpected dataRow message from backend.");this._handleErrorEvent(e);return}t.handleDataRow(e)}_handlePortalSuspended(e){let t=this._getActiveQuery();if(null==t){let e=Error("Received unexpected portalSuspended message from backend.");this._handleErrorEvent(e);return}t.handlePortalSuspended(this.connection)}_handleEmptyQuery(e){let t=this._getActiveQuery();if(null==t){let e=Error("Received unexpected emptyQuery message from backend.");this._handleErrorEvent(e);return}t.handleEmptyQuery(this.connection)}_handleCommandComplete(e){let t=this._getActiveQuery();if(null==t){let e=Error("Received unexpected commandComplete message from backend.");this._handleErrorEvent(e);return}t.handleCommandComplete(e,this.connection)}_handleParseComplete(){let e=this._getActiveQuery();if(null==e){let e=Error("Received unexpected parseComplete message from backend.");this._handleErrorEvent(e);return}e.name&&(this.connection.parsedStatements[e.name]=e.text)}_handleCopyInResponse(e){let t=this._getActiveQuery();if(null==t){let e=Error("Received unexpected copyInResponse message from backend.");this._handleErrorEvent(e);return}t.handleCopyInResponse(this.connection)}_handleCopyData(e){let t=this._getActiveQuery();if(null==t){let e=Error("Received unexpected copyData message from backend.");this._handleErrorEvent(e);return}t.handleCopyData(e,this.connection)}_handleNotification(e){this.emit("notification",e)}_handleNotice(e){this.emit("notice",e)}getStartupConf(){let e=this.connectionParameters,t={user:e.user,database:e.database},i=e.application_name||e.fallback_application_name;return i&&(t.application_name=i),e.replication&&(t.replication=""+e.replication),e.statement_timeout&&(t.statement_timeout=String(parseInt(e.statement_timeout,10))),e.lock_timeout&&(t.lock_timeout=String(parseInt(e.lock_timeout,10))),e.idle_in_transaction_session_timeout&&(t.idle_in_transaction_session_timeout=String(parseInt(e.idle_in_transaction_session_timeout,10))),e.options&&(t.options=e.options),t}cancel(e,t){if(e.activeQuery===t){let t=this.connection;this.host&&0===this.host.indexOf("/")?t.connect(this.host+"/.s.PGSQL."+this.port):t.connect(this.port,this.host),t.on("connect",function(){t.cancel(e.processID,e.secretKey)})}else -1!==e._queryQueue.indexOf(t)&&e._queryQueue.splice(e._queryQueue.indexOf(t),1)}setTypeParser(e,t,i){return this._types.setTypeParser(e,t,i)}getTypeParser(e,t){return this._types.getTypeParser(e,t)}escapeIdentifier(e){return r.escapeIdentifier(e)}escapeLiteral(e){return r.escapeLiteral(e)}_pulseQueryQueue(){if(!0===this.readyForQuery){this._activeQuery=this._queryQueue.shift();let e=this._getActiveQuery();if(e){this.readyForQuery=!1,this.hasExecuted=!0;let t=e.submit(this.connection);t&&process.nextTick(()=>{e.handleError(t,this.connection),this.readyForQuery=!0,this._pulseQueryQueue()})}else this.hasExecuted&&(this._activeQuery=null,this.emit("drain"))}}query(e,t,i){let s,r,n,a,o;if(null==e)throw TypeError("Client was passed a null or undefined query");return("function"==typeof e.submit?(n=e.query_timeout||this.connectionParameters.query_timeout,r=s=e,"function"==typeof t&&(s.callback=s.callback||t)):(n=e.query_timeout||this.connectionParameters.query_timeout,(s=new l(e,t,i)).callback||(r=new this._Promise((e,t)=>{s.callback=(i,s)=>i?t(i):e(s)}).catch(e=>{throw Error.captureStackTrace(e),e}))),n&&(o=s.callback,a=setTimeout(()=>{let e=Error("Query read timeout");process.nextTick(()=>{s.handleError(e,this.connection)}),o(e),s.callback=()=>{};let t=this._queryQueue.indexOf(s);t>-1&&this._queryQueue.splice(t,1),this._pulseQueryQueue()},n),s.callback=(e,t)=>{clearTimeout(a),o(e,t)}),this.binary&&!s.binary&&(s.binary=!0),s._result&&!s._result._types&&(s._result._types=this._types),this._queryable)?this._ending?process.nextTick(()=>{s.handleError(Error("Client was closed and is not queryable"),this.connection)}):(this._queryQueue.push(s),this._pulseQueryQueue()):process.nextTick(()=>{s.handleError(Error("Client has encountered a connection error and is not queryable"),this.connection)}),r}ref(){this.connection.ref()}unref(){this.connection.unref()}end(e){if(this._ending=!0,!this.connection._connecting||this._ended)if(!e)return this._Promise.resolve();else e();if(this._getActiveQuery()||!this._queryable?this.connection.stream.destroy():this.connection.end(),!e)return new this._Promise(e=>{this.connection.once("end",e)});this.connection.once("end",e)}get queryQueue(){return f(),this._queryQueue}}y.Query=l,t.exports=y},34291,(e,t,i)=>{"use strict";let s=e.r(27699).EventEmitter,r=function(){},n=(e,t)=>{let i=e.findIndex(t);return -1===i?void 0:e.splice(i,1)[0]};class a{constructor(e,t,i){this.client=e,this.idleListener=t,this.timeoutId=i}}class o{constructor(e){this.callback=e}}function c(e,t){let i,s;return t?{callback:t,result:void 0}:{callback:function(e,t){e?i(e):s(t)},result:new e(function(e,t){s=e,i=t}).catch(e=>{throw Error.captureStackTrace(e),e})}}t.exports=class extends s{constructor(t,i){super(),this.options=Object.assign({},t),null!=t&&"password"in t&&Object.defineProperty(this.options,"password",{configurable:!0,enumerable:!1,writable:!0,value:t.password}),null!=t&&t.ssl&&t.ssl.key&&Object.defineProperty(this.options.ssl,"key",{enumerable:!1}),this.options.max=this.options.max||this.options.poolSize||10,this.options.min=this.options.min||0,this.options.maxUses=this.options.maxUses||1/0,this.options.allowExitOnIdle=this.options.allowExitOnIdle||!1,this.options.maxLifetimeSeconds=this.options.maxLifetimeSeconds||0,this.log=this.options.log||function(){},this.Client=this.options.Client||i||e.r(46912).Client,this.Promise=this.options.Promise||e.g.Promise,void 0===this.options.idleTimeoutMillis&&(this.options.idleTimeoutMillis=1e4),this._clients=[],this._idle=[],this._expired=new WeakSet,this._pendingQueue=[],this._endCallback=void 0,this.ending=!1,this.ended=!1}_isFull(){return this._clients.length>=this.options.max}_isAboveMin(){return this._clients.length>this.options.min}_pulseQueue(){if(this.log("pulse queue"),this.ended)return void this.log("pulse queue ended");if(this.ending){this.log("pulse queue on ending"),this._idle.length&&this._idle.slice().map(e=>{this._remove(e.client)}),this._clients.length||(this.ended=!0,this._endCallback());return}if(!this._pendingQueue.length)return void this.log("no queued requests");if(!this._idle.length&&this._isFull())return;let e=this._pendingQueue.shift();if(this._idle.length){let t=this._idle.pop();clearTimeout(t.timeoutId);let i=t.client;i.ref&&i.ref();let s=t.idleListener;return this._acquireClient(i,e,s,!1)}if(!this._isFull())return this.newClient(e);throw Error("unexpected condition")}_remove(e,t){let i=n(this._idle,t=>t.client===e);void 0!==i&&clearTimeout(i.timeoutId),this._clients=this._clients.filter(t=>t!==e);let s=this;e.end(()=>{s.emit("remove",e),"function"==typeof t&&t()})}connect(e){if(this.ending){let t=Error("Cannot use a pool after calling end on the pool");return e?e(t):this.Promise.reject(t)}let t=c(this.Promise,e),i=t.result;if(this._isFull()||this._idle.length){if(this._idle.length&&process.nextTick(()=>this._pulseQueue()),!this.options.connectionTimeoutMillis)return this._pendingQueue.push(new o(t.callback)),i;let e=(e,i,s)=>{clearTimeout(r),t.callback(e,i,s)},s=new o(e),r=setTimeout(()=>{n(this._pendingQueue,t=>t.callback===e),s.timedOut=!0,t.callback(Error("timeout exceeded when trying to connect"))},this.options.connectionTimeoutMillis);return r.unref&&r.unref(),this._pendingQueue.push(s),i}return this.newClient(new o(t.callback)),i}newClient(e){var t;let i,s=new this.Client(this.options);this._clients.push(s);let n=(t=this,function e(i){i.client=s,s.removeListener("error",e),s.on("error",()=>{t.log("additional client error after disconnection due to error",i)}),t._remove(s),t.emit("error",i,s)});this.log("checking client timeout");let a=!1;this.options.connectionTimeoutMillis&&(i=setTimeout(()=>{this.log("ending client due to timeout"),a=!0,s.connection?s.connection.stream.destroy():s.end()},this.options.connectionTimeoutMillis)),this.log("connecting new client"),s.connect(t=>{if(i&&clearTimeout(i),s.on("error",n),t)this.log("client failed to connect",t),this._clients=this._clients.filter(e=>e!==s),a&&(t=Error("Connection terminated due to connection timeout",{cause:t})),this._pulseQueue(),e.timedOut||e.callback(t,void 0,r);else{if(this.log("new client connected"),0!==this.options.maxLifetimeSeconds){let e=setTimeout(()=>{this.log("ending client due to expired lifetime"),this._expired.add(s),-1!==this._idle.findIndex(e=>e.client===s)&&this._acquireClient(s,new o((e,t,i)=>i()),n,!1)},1e3*this.options.maxLifetimeSeconds);e.unref(),s.once("end",()=>clearTimeout(e))}return this._acquireClient(s,e,n,!0)}})}_acquireClient(e,t,i,s){s&&this.emit("connect",e),this.emit("acquire",e),e.release=this._releaseOnce(e,i),e.removeListener("error",i),t.timedOut?s&&this.options.verify?this.options.verify(e,e.release):e.release():s&&this.options.verify?this.options.verify(e,i=>{if(i)return e.release(i),t.callback(i,void 0,r);t.callback(void 0,e,e.release)}):t.callback(void 0,e,e.release)}_releaseOnce(e,t){let i=!1;return s=>{i&&function(){throw Error("Release called on client which has already been released to the pool.")}(),i=!0,this._release(e,t,s)}}_release(e,t,i){let s;return(e.on("error",t),e._poolUseCount=(e._poolUseCount||0)+1,this.emit("release",i,e),i||this.ending||!e._queryable||e._ending||e._poolUseCount>=this.options.maxUses)?(e._poolUseCount>=this.options.maxUses&&this.log("remove expended client"),this._remove(e,this._pulseQueue.bind(this))):this._expired.has(e)?(this.log("remove expired client"),this._expired.delete(e),this._remove(e,this._pulseQueue.bind(this))):void(this.options.idleTimeoutMillis&&this._isAboveMin()&&(s=setTimeout(()=>{this._isAboveMin()&&(this.log("remove idle client"),this._remove(e,this._pulseQueue.bind(this)))},this.options.idleTimeoutMillis),this.options.allowExitOnIdle&&s.unref()),this.options.allowExitOnIdle&&e.unref(),this._idle.push(new a(e,t,s)),this._pulseQueue())}query(e,t,i){if("function"==typeof e){let t=c(this.Promise,e);return setImmediate(function(){return t.callback(Error("Passing a function as the first parameter to pool.query is not supported"))}),t.result}"function"==typeof t&&(i=t,t=void 0);let s=c(this.Promise,i);return i=s.callback,this.connect((s,r)=>{if(s)return i(s);let n=!1,a=e=>{n||(n=!0,r.release(e),i(e))};r.once("error",a),this.log("dispatching query");try{r.query(e,t,(e,t)=>{if(this.log("query dispatched"),r.removeListener("error",a),!n)return(n=!0,r.release(e),e)?i(e):i(void 0,t)})}catch(e){return r.release(e),i(e)}}),s.result}end(e){if(this.log("ending"),this.ending){let t=Error("Called end on pool more than once");return e?e(t):this.Promise.reject(t)}this.ending=!0;let t=c(this.Promise,e);return this._endCallback=t.callback,this._pulseQueue(),t.result}get waitingCount(){return this._pendingQueue.length}get idleCount(){return this._idle.length}get expiredCount(){return this._clients.reduce((e,t)=>e+ +!!this._expired.has(t),0)}get totalCount(){return this._clients.length}}},77096,(e,t,i)=>{"use strict";let s=e.r(27699).EventEmitter,r=e.r(24361),n=e.r(78076),a=t.exports=function(e,t,i){s.call(this),e=n.normalizeQueryConfig(e,t,i),this.text=e.text,this.values=e.values,this.name=e.name,this.queryMode=e.queryMode,this.callback=e.callback,this.state="new",this._arrayMode="array"===e.rowMode,this._emitRowEvents=!1,this.on("newListener",(function(e){"row"===e&&(this._emitRowEvents=!0)}).bind(this))};r.inherits(a,s);let o={sqlState:"code",statementPosition:"position",messagePrimary:"message",context:"where",schemaName:"schema",tableName:"table",columnName:"column",dataTypeName:"dataType",constraintName:"constraint",sourceFile:"file",sourceLine:"line",sourceFunction:"routine"};a.prototype.handleError=function(e){let t=this.native.pq.resultErrorFields();if(t)for(let i in t)e[o[i]||i]=t[i];this.callback?this.callback(e):this.emit("error",e),this.state="error"},a.prototype.then=function(e,t){return this._getPromise().then(e,t)},a.prototype.catch=function(e){return this._getPromise().catch(e)},a.prototype._getPromise=function(){return this._promise||(this._promise=new Promise((function(e,t){this._once("end",e),this._once("error",t)}).bind(this))),this._promise},a.prototype.submit=function(e){this.state="running";let t=this;this.native=e.native,e.native.arrayMode=this._arrayMode;let i=function(i,s,r){if(e.native.arrayMode=!1,setImmediate(function(){t.emit("_done")}),i)return t.handleError(i);t._emitRowEvents&&(r.length>1?s.forEach((e,i)=>{e.forEach(e=>{t.emit("row",e,r[i])})}):s.forEach(function(e){t.emit("row",e,r)})),t.state="end",t.emit("end",r),t.callback&&t.callback(null,r)};if(process.domain&&(i=process.domain.bind(i)),this.name){this.name.length>63&&(console.error("Warning! Postgres only supports 63 characters for query names."),console.error("You supplied %s (%s)",this.name,this.name.length),console.error("This can cause conflicts and silent errors executing queries"));let s=(this.values||[]).map(n.prepareValue);if(e.namedQueries[this.name]){if(this.text&&e.namedQueries[this.name]!==this.text){let e=Error(`Prepared statements must be unique - '${this.name}' was used for a different statement`);return i(e)}return e.native.execute(this.name,s,i)}return e.native.prepare(this.name,this.text,s.length,function(r){return r?i(r):(e.namedQueries[t.name]=t.text,t.native.execute(t.name,s,i))})}if(this.values){if(!Array.isArray(this.values)){let e=Error("Query values must be an array");return i(e)}let t=this.values.map(n.prepareValue);e.native.query(this.text,t,i)}else"extended"===this.queryMode?e.native.query(this.text,[],i):e.native.query(this.text,i)}},37409,(e,t,i)=>{"use strict";var s;try{s=(()=>{let e=Error("Cannot find module 'pg-native'");throw e.code="MODULE_NOT_FOUND",e})()}catch(e){throw e}let r=e.r(94163),n=e.r(27699).EventEmitter,a=e.r(24361),o=e.r(38177),c=e.r(77096),l=t.exports=function(t){n.call(this),t=t||{},this._Promise=t.Promise||e.g.Promise,this._types=new r(t.types),this.native=new s({types:this._types}),this._queryQueue=[],this._ending=!1,this._connecting=!1,this._connected=!1,this._queryable=!0;let i=this.connectionParameters=new o(t);t.nativeConnectionString&&(i.nativeConnectionString=t.nativeConnectionString),this.user=i.user,Object.defineProperty(this,"password",{configurable:!0,enumerable:!1,writable:!0,value:i.password}),this.database=i.database,this.host=i.host,this.port=i.port,this.namedQueries={}};l.Query=c,a.inherits(l,n),l.prototype._errorAllQueries=function(e){let t=t=>{process.nextTick(()=>{t.native=this.native,t.handleError(e)})};this._hasActiveQuery()&&(t(this._activeQuery),this._activeQuery=null),this._queryQueue.forEach(t),this._queryQueue.length=0},l.prototype._connect=function(e){let t=this;this._connecting?process.nextTick(()=>e(Error("Client has already been connected. You cannot reuse a client."))):(this._connecting=!0,this.connectionParameters.getLibpqConnectionString(function(i,s){if(t.connectionParameters.nativeConnectionString&&(s=t.connectionParameters.nativeConnectionString),i)return e(i);t.native.connect(s,function(i){if(i)return t.native.end(),e(i);t._connected=!0,t.native.on("error",function(e){t._queryable=!1,t._errorAllQueries(e),t.emit("error",e)}),t.native.on("notification",function(e){t.emit("notification",{channel:e.relname,payload:e.extra})}),t.emit("connect"),t._pulseQueryQueue(!0),e(null,this)})}))},l.prototype.connect=function(e){return e?void this._connect(e):new this._Promise((e,t)=>{this._connect(i=>{i?t(i):e(this)})})},l.prototype.query=function(e,t,i){let s,r,n,a,o;if(null==e)throw TypeError("Client was passed a null or undefined query");if("function"==typeof e.submit)n=e.query_timeout||this.connectionParameters.query_timeout,r=s=e,"function"==typeof t&&(e.callback=t);else if(n=e.query_timeout||this.connectionParameters.query_timeout,!(s=new c(e,t,i)).callback){let e,t;r=new this._Promise((i,s)=>{e=i,t=s}).catch(e=>{throw Error.captureStackTrace(e),e}),s.callback=(i,s)=>i?t(i):e(s)}return(n&&(o=s.callback,a=setTimeout(()=>{let e=Error("Query read timeout");process.nextTick(()=>{s.handleError(e,this.connection)}),o(e),s.callback=()=>{};let t=this._queryQueue.indexOf(s);t>-1&&this._queryQueue.splice(t,1),this._pulseQueryQueue()},n),s.callback=(e,t)=>{clearTimeout(a),o(e,t)}),this._queryable)?this._ending?(s.native=this.native,process.nextTick(()=>{s.handleError(Error("Client was closed and is not queryable"))})):(this._queryQueue.push(s),this._pulseQueryQueue()):(s.native=this.native,process.nextTick(()=>{s.handleError(Error("Client has encountered a connection error and is not queryable"))})),r},l.prototype.end=function(e){let t,i=this;return this._ending=!0,this._connected||this.once("connect",this.end.bind(this,e)),e||(t=new this._Promise(function(t,i){e=e=>e?i(e):t()})),this.native.end(function(){i._errorAllQueries(Error("Connection terminated")),process.nextTick(()=>{i.emit("end"),e&&e()})}),t},l.prototype._hasActiveQuery=function(){return this._activeQuery&&"error"!==this._activeQuery.state&&"end"!==this._activeQuery.state},l.prototype._pulseQueryQueue=function(e){if(!this._connected||this._hasActiveQuery())return;let t=this._queryQueue.shift();if(!t){e||this.emit("drain");return}this._activeQuery=t,t.submit(this);let i=this;t.once("_done",function(){i._pulseQueryQueue()})},l.prototype.cancel=function(e){this._activeQuery===e?this.native.cancel(function(){}):-1!==this._queryQueue.indexOf(e)&&this._queryQueue.splice(this._queryQueue.indexOf(e),1)},l.prototype.ref=function(){},l.prototype.unref=function(){},l.prototype.setTypeParser=function(e,t,i){return this._types.setTypeParser(e,t,i)},l.prototype.getTypeParser=function(e,t){return this._types.getTypeParser(e,t)}},45713,(e,t,i)=>{"use strict";t.exports=e.r(37409)},46912,(e,t,i)=>{"use strict";let s=e.r(4448),r=e.r(91011),n=e.r(29760),a=e.r(88851),o=e.r(78076),c=e.r(34291),l=e.r(94163),{DatabaseError:h}=e.r(86833),{escapeIdentifier:u,escapeLiteral:d}=e.r(78076),p=function(t){let i;this.defaults=r,this.Client=t,this.Query=this.Client.Query,this.Pool=(i=this.Client,class extends c{constructor(e){super(e,i)}}),this._pools=[],this.Connection=n,this.types=e.r(85306),this.DatabaseError=h,this.TypeOverrides=l,this.escapeIdentifier=u,this.escapeLiteral=d,this.Result=a,this.utils=o},f=s,m=!1;try{m=!!process.env.NODE_PG_FORCE_NATIVE}catch{}m&&(f=e.r(45713)),t.exports=new p(f),Object.defineProperty(t.exports,"native",{configurable:!0,enumerable:!1,get(){let i=null;try{i=new p(e.r(45713))}catch(e){if("MODULE_NOT_FOUND"!==e.code)throw e}return Object.defineProperty(t.exports,"native",{value:i}),i}})},77691,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.withConnection=void 0,i.withConnection=function(e,t){return async i=>{try{try{e("Connecting to database..."),await i.connect(),e("... connected to database")}catch(t){throw e(`Error connecting to database: ${t.message}`),t}return await t(i)}catch(t){throw e(`Error using connection: ${t.message}`),t}finally{try{e("Closing connection..."),await i.end(),e("... connection closed")}catch(t){e(`Error closing the connection: ${t.message}`)}}}}},22551,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.runSchemaQuery=i.runCreateQuery=i.createDb=void 0;let s=e.r(46912),r=e.r(77691);function n(e,t){return async i=>{await i.query(`CREATE DATABASE "${e.replace(/\"/g,'""')}"`).catch(i=>{if("42P04"===i.code)return void t(`'${e}' database already exists`);throw t(i),Error(`Error creating database. Caused by: '${i.name}: ${i.message}'`)})}}i.createDb=async function(e,t,i={}){if("string"!=typeof e)throw Error("Must pass database name as a string");let a=null!=i.logger?i.logger:()=>{};if(null==t)throw Error("No config object");if("client"in t)return n(e,a)(t.client);if("string"!=typeof t.user||"string"!=typeof t.password||"string"!=typeof t.host||"number"!=typeof t.port)throw Error("Database config problem");let{user:o,password:c,host:l,port:h}=t,u=new s.Client({database:null!=t.defaultDatabase?t.defaultDatabase:"postgres",user:o,password:c,host:l,port:h});return u.on("error",e=>{a(`pg client emitted an error: ${e.message}`)}),r.withConnection(a,n(e,a))(u)},i.runCreateQuery=n,i.runSchemaQuery=function(e,t){return async i=>{await i.query(`CREATE SCHEMA IF NOT EXISTS ${e}`).catch(i=>{t(`'${e}' scheme already exists`)})}}},72982,(e,t,i)=>{"use strict";class s{constructor(e,t){this.strings=e,this.values=t}get query(){return this.bind?this.text:this.sql}get text(){return this.strings.reduce((e,t,i)=>e+"$"+i+t)}append(e){return e instanceof s?(this.strings[this.strings.length-1]+=e.strings[0],this.strings.push.apply(this.strings,e.strings.slice(1)),(this.values||this.bind).push.apply(this.values,e.values)):this.strings[this.strings.length-1]+=e,this}useBind(e){return void 0===e&&(e=!0),e&&!this.bind?(this.bind=this.values,delete this.values):!e&&this.bind&&(this.values=this.bind,delete this.bind),this}setName(e){return this.name=e,this}}function r(e){return new s(e.slice(0),Array.from(arguments).slice(1))}Object.defineProperty(s.prototype,"sql",{enumerable:!0,get(){return this.strings.join("?")}}),t.exports=r,t.exports.SQL=r,t.exports.default=r,t.exports.SQLStatement=s},11092,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.loadSqlFromJs=void 0;let s=e.r(14747);i.loadSqlFromJs=e=>{let t=(()=>{let e=Error("Cannot find module as expression is too dynamic");throw e.code="MODULE_NOT_FOUND",e})();if(!t.generateSql)throw Error(`Invalid javascript migration file: '${s.basename(e)}'.
It must to export a 'generateSql' function.`);let i=t.generateSql();if("string"!=typeof i)throw Error(`Invalid javascript migration file: '${s.basename(e)}'.
'generateSql' function must return a string literal.`);return i}},75476,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.parseFileName=void 0,i.parseFileName=e=>{let t=/^(-?\d+)[-_]?(.*).(sql|js)$/gi.exec(e);if(!t)throw Error(`Invalid file name: '${e}'.`);let[,i,s,r]=t,n=r.toLowerCase();if("js"!==n&&"sql"!==n)throw Error("Not a JS or SQL file");return{id:(e=>{let t=parseInt(e,10);if(isNaN(t))throw Error("Migration file name should begin with an integer ID.'");return t})(i),name:null==s||""===s?e:s,type:n}}},33071,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.loadMigrationFile=void 0;let s=e.r(24361),r=e.r(22734),n=e.r(14747),a=e.r(54799),o=e.r(11092),c=e.r(75476),l=s.promisify(r.readFile),h=async e=>l(e,"utf8");i.loadMigrationFile=async e=>{let t=n.basename(e);try{let i,{id:s,name:r,type:n}=c.parseFileName(t),l=await h(e),u=((e,t,i)=>{switch(i){case"sql":return t;case"js":return o.loadSqlFromJs(e);default:return i}})(e,l,n),d=(i=t+u,a.createHash("sha1").update(i,"utf8").digest("hex"));return{id:s,name:r,contents:l,fileName:t,hash:d,sql:u}}catch(e){throw Error(`${e.message} - Offending file: '${t}'.`)}}},2235,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.validateMigrationHashes=i.validateMigrationOrdering=void 0;let s=(e,t)=>e.id!==t;i.validateMigrationOrdering=function(e){let t=e.find(s);if(t)throw Error(`Found a non-consecutive migration ID on file: '${t.fileName}'`)},i.validateMigrationHashes=function(e,t){let i=e.filter(e=>{let i=t[e.id];return null!=i&&i.hash!==e.hash});if(i.length>0){let e=i.map(({fileName:e})=>e);throw Error(`Hashes don't match for migrations '${e}'.
This means that the scripts have changed since it was applied.`)}}},5519,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.loadMigrationFiles=void 0;let s=e.r(22734),r=e.r(14747),n=e.r(24361),a=e.r(33071),o=e.r(2235),c=n.promisify(s.readdir),l=e=>/\.(sql|js)$/gi.test(e);i.loadMigrationFiles=async(e,t=()=>{})=>{t(`Loading migrations from: ${e}`);let i=await c(e);if(t(`Found migration files: ${i}`),null==i)return[];let s=[...i.map(t=>r.resolve(e,t))].filter(l),n=(await Promise.all(s.map(a.loadMigrationFile))).sort((e,t)=>e.id-t.id);return o.validateMigrationOrdering(n),n}},48846,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.runMigration=void 0;let s=e.r(72982),r=()=>{},n=async(e="migrations",t="public",i,r,n)=>{n(`Saving migration to '${t}.${e}': ${r.id} | ${r.name} | ${r.hash}`);let a=s.default`INSERT INTO `.append(`${t}.${e}`).append(s.default` ("id", "name", "hash") VALUES (${r.id},${r.name},${r.hash})`);return i.query(a)};i.runMigration=(e="migrations",t="public",i,s=r)=>async a=>{let o=!1===a.sql.includes("-- postgres-migrations disable-transaction");s(`Running migration in transaction: ${o}`);let c=o?()=>i.query("START TRANSACTION"):r,l=o?()=>i.query("COMMIT"):r,h=o?()=>i.query("ROLLBACK"):r;try{return await c(),await i.query(a.sql),await n(e,t,i,a,s),await l(),a}catch(e){try{await h()}catch(e){}throw Error(`An error occurred running '${a.name}'. Rolled back this migration. No further migrations were run. Reason: ${e.message}`)}}},71530,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.withAdvisoryLock=void 0,i.withAdvisoryLock=function(e,t){return async i=>{try{try{e("Acquiring advisory lock...");let t=!1;for(;!t;){let e=await i.query("SELECT pg_try_advisory_lock(-8525285245963000605);");!0===e.rows[0].pg_try_advisory_lock?t=!0:await new Promise(e=>setTimeout(e,1e3))}e("... acquired advisory lock")}catch(t){throw e(`Error acquiring advisory lock: ${t.message}`),t}return await t(i)}catch(t){throw e(`Error while using lock: ${t.message}`),t}finally{try{e("Releasing advisory lock..."),await i.query("SELECT pg_advisory_unlock(-8525285245963000605);"),e("... released advisory lock")}catch(t){e(`Error releasing advisory lock: ${t.message}`)}}}}},68980,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.migrate=void 0;let s=e.r(46912),r=e.r(72982),n=e.r(22551),a=e.r(5519),o=e.r(48846),c=e.r(2235),l=e.r(77691),h=e.r(71530);function u(e,t,i){return async s=>{try{var r,n,a;t(`Starting migrations against schema ${i.schemaName}`);let l=await d(i.tableName,i.schemaName,s,t);c.validateMigrationHashes(e,l);let h=(r=e,n=l,r.filter(e=>!n[e.id])),u=[];for(let e of h){t(`Starting migration: ${e.id} ${e.name}`);let r=await o.runMigration(i.tableName,i.schemaName,s,t)(e);t(`Finished migration: ${e.id} ${e.name}`),u.push(r)}return a=u,t(0===a.length?"No migrations applied":`Successfully applied migrations: ${a.map(({name:e})=>e)}`),t("Finished migrations"),u}catch(t){let e=Error(`Migration failed. Reason: ${t.message}`);throw e.cause=t.message,e}}}async function d(e,t,i,s){let r=[];if(await p(i,e,t)){s(`Migrations table with name '${t}.${e}' exists, filtering not applied migrations.`);let{rows:n}=await i.query(`SELECT * FROM ${t}.${e} ORDER BY id`);r=n}else await i.query(`
        CREATE TABLE IF NOT EXISTS ${t}.${e} (
          id integer PRIMARY KEY,
          name varchar(100) UNIQUE NOT NULL,
          hash varchar(40) NOT NULL, -- sha1 hex encoded hash of the file name and contents, to ensure it hasn't been altered since applying the migration
          executed_at timestamp DEFAULT current_timestamp
        );
    `),s(`Migrations table with name '${t}.${e}' has been created!`);return r}async function p(e,t,i){let s=await e.query(r.default`SELECT EXISTS (
    SELECT 1
    FROM information_schema.tables
    WHERE table_schema = ${i}
    AND table_name = ${t}
  );`);return s.rows.length>0&&s.rows[0].exists}i.migrate=async function(e,t,i={}){let r=null!=i.logger?i.logger:()=>{},o={tableName:"tableName"in i&&void 0!==i.tableName?i.tableName:"migrations",schemaName:"schemaName"in i&&void 0!==i.schemaName?i.schemaName:"public"};if(null==e)throw Error("No config object");if("string"!=typeof t)throw Error("Must pass migrations directory as a string");let c=await a.loadMigrationFiles(t,r);if("client"in e)return h.withAdvisoryLock(r,u(c,r,o))(e.client);if("string"!=typeof e.database||"string"!=typeof e.user||"string"!=typeof e.password||"string"!=typeof e.host||"number"!=typeof e.port)throw Error("Database config problem");if(!0===e.ensureDatabaseExists){let{user:t,password:i,host:a,port:c}=e,h=new s.Client({database:null!=e.defaultDatabase?e.defaultDatabase:"postgres",user:t,password:i,host:a,port:c}),u=l.withConnection(r,async t=>{1!==(await t.query({text:"SELECT 1 FROM pg_database WHERE datname=$1",values:[e.database]})).rowCount&&await n.runCreateQuery(e.database,r)(t)});await u(h);let d=l.withConnection(r,async e=>{await n.runSchemaQuery(o.schemaName,r)(e)});await d(h)}{let t=new s.Client(e);return t.on("error",e=>{r(`pg client emitted an error: ${e.message}`)}),l.withConnection(r,h.withAdvisoryLock(r,u(c,r,o)))(t)}}},55917,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.MigrationError=void 0,i.MigrationError=class extends Error{}},41551,(e,t,i)=>{"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.MigrationError=i.loadMigrationFiles=i.migrate=i.createDb=void 0;var s=e.r(22551);Object.defineProperty(i,"createDb",{enumerable:!0,get:function(){return s.createDb}});var r=e.r(68980);Object.defineProperty(i,"migrate",{enumerable:!0,get:function(){return r.migrate}});var n=e.r(5519);Object.defineProperty(i,"loadMigrationFiles",{enumerable:!0,get:function(){return n.loadMigrationFiles}});var a=e.r(55917);Object.defineProperty(i,"MigrationError",{enumerable:!0,get:function(){return a.MigrationError}})},92509,(e,t,i)=>{t.exports=e.x("url",()=>require("url"))},32814,e=>{"use strict";var t=e.i(63242),i=e.i(68437),s=e.i(46912);let r=s.default.Client;s.default.Pool,s.default.Connection,s.default.types,s.default.Query,s.default.DatabaseError,s.default.escapeIdentifier,s.default.escapeLiteral,s.default.Result,s.default.TypeOverrides,s.default.defaults;let n=s.default;var a=e.i(54799),o=e.i(41551),c=e.i(22734),l=e.i(14747),h=e.i(92509),u=["subscription_items","subscriptions","subscription_schedules","checkout_session_line_items","checkout_sessions","tax_ids","charges","refunds","credit_notes","disputes","early_fraud_warnings","invoices","payment_intents","payment_methods","setup_intents","prices","plans","products","features","active_entitlements","reviews","_managed_webhooks","customers","_sync_status"],d=class{constructor(e){this.config=e,this.pool=new n.Pool(e.poolConfig)}pool;async delete(e,t){let s=(0,i.pg)(`
    delete from "${this.config.schema}"."${e}"
    where id = :id
    returning id;
    `)({id:t}),{rows:r}=await this.query(s.text,s.values);return r.length>0}async query(e,t){return this.pool.query(e,t)}async upsertMany(e,t){if(!e.length)return[];let i=[];for(let s=0;s<e.length;s+=5){let r=e.slice(s,s+5),n=[];r.forEach(e=>{let i=JSON.stringify(e),s=`
          INSERT INTO "${this.config.schema}"."${t}" ("_raw_data")
          VALUES ($1::jsonb)
          ON CONFLICT (id)
          DO UPDATE SET
            "_raw_data" = EXCLUDED."_raw_data"
          RETURNING *
        `;n.push(this.pool.query(s,[i]))}),i.push(...await Promise.all(n))}return i.flatMap(e=>e.rows)}async upsertManyWithTimestampProtection(e,t,s,r){let n=r||new Date().toISOString();if(!e.length)return[];let a=[];for(let r=0;r<e.length;r+=5){let o=e.slice(r,r+5),c=[];o.forEach(e=>{if(t.startsWith("_")){let r=Object.keys(e).filter(e=>"last_synced_at"!==e&&"account_id"!==e),a=`
            INSERT INTO "${this.config.schema}"."${t}" (
              ${r.map(e=>`"${e}"`).join(", ")}, "last_synced_at", "account_id"
            )
            VALUES (
              ${r.map(e=>`:${e}`).join(", ")}, :last_synced_at, :account_id
            )
            ON CONFLICT ("id")
            DO UPDATE SET
              ${r.map(e=>`"${e}" = EXCLUDED."${e}"`).join(", ")},
              "last_synced_at" = :last_synced_at,
              "account_id" = EXCLUDED."account_id"
            WHERE "${t}"."last_synced_at" IS NULL
               OR "${t}"."last_synced_at" < :last_synced_at
            RETURNING *
          `,o=this.cleanseArrayField(e);o.last_synced_at=n,o.account_id=s;let l=(0,i.pg)(a,{useNullForMissing:!0})(o);c.push(this.pool.query(l.text,l.values))}else{let i=JSON.stringify(e),r=`
            INSERT INTO "${this.config.schema}"."${t}" ("_raw_data", "_last_synced_at", "_account_id")
            VALUES ($1::jsonb, $2, $3)
            ON CONFLICT (id)
            DO UPDATE SET
              "_raw_data" = EXCLUDED."_raw_data",
              "_last_synced_at" = $2,
              "_account_id" = EXCLUDED."_account_id"
            WHERE "${t}"."_last_synced_at" IS NULL
               OR "${t}"."_last_synced_at" < $2
            RETURNING *
          `;c.push(this.pool.query(r,[i,n,s]))}}),a.push(...await Promise.all(c))}return a.flatMap(e=>e.rows)}cleanseArrayField(e){let t={...e};return Object.keys(t).map(e=>{let i=t[e];Array.isArray(i)&&(t[e]=JSON.stringify(i))}),t}async findMissingEntries(e,t){if(!t.length)return[];let s=(0,i.pg)(`
    select id from "${this.config.schema}"."${e}"
    where id=any(:ids::text[]);
    `)({ids:t}),{rows:r}=await this.query(s.text,s.values),n=r.map(e=>e.id);return t.filter(e=>!n.includes(e))}async getSyncCursor(e,t){let i=await this.query(`SELECT EXTRACT(EPOCH FROM last_incremental_cursor)::integer as cursor
       FROM "${this.config.schema}"."_sync_status"
       WHERE resource = $1 AND "account_id" = $2`,[e,t]);return i.rows[0]?.cursor??null}async updateSyncCursor(e,t,i){await this.query(`INSERT INTO "${this.config.schema}"."_sync_status" (resource, "account_id", last_incremental_cursor, status, last_synced_at)
       VALUES ($1, $2, to_timestamp($3), 'running', now())
       ON CONFLICT (resource, "account_id")
       DO UPDATE SET
         last_incremental_cursor = GREATEST(
           COALESCE("${this.config.schema}"."_sync_status".last_incremental_cursor, to_timestamp(0)),
           to_timestamp($3)
         ),
         last_synced_at = now(),
         updated_at = now()`,[e,t,i.toString()])}async markSyncRunning(e,t){await this.query(`INSERT INTO "${this.config.schema}"."_sync_status" (resource, "account_id", status)
       VALUES ($1, $2, 'running')
       ON CONFLICT (resource, "account_id")
       DO UPDATE SET status = 'running', updated_at = now()`,[e,t])}async markSyncComplete(e,t){await this.query(`UPDATE "${this.config.schema}"."_sync_status"
       SET status = 'complete', error_message = NULL, updated_at = now()
       WHERE resource = $1 AND "account_id" = $2`,[e,t])}async markSyncError(e,t,i){await this.query(`UPDATE "${this.config.schema}"."_sync_status"
       SET status = 'error', error_message = $3, updated_at = now()
       WHERE resource = $1 AND "account_id" = $2`,[e,t,i])}async upsertAccount(e,t){let i=JSON.stringify(e.raw_data);await this.query(`INSERT INTO "${this.config.schema}"."accounts" ("_raw_data", "api_key_hashes", "first_synced_at", "_last_synced_at")
       VALUES ($1::jsonb, ARRAY[$2], now(), now())
       ON CONFLICT (id)
       DO UPDATE SET
         "_raw_data" = EXCLUDED."_raw_data",
         "api_key_hashes" = (
           SELECT ARRAY(
             SELECT DISTINCT unnest(
               COALESCE("${this.config.schema}"."accounts"."api_key_hashes", '{}') || ARRAY[$2]
             )
           )
         ),
         "_last_synced_at" = now(),
         "_updated_at" = now()`,[i,t])}async getAllAccounts(){return(await this.query(`SELECT _raw_data FROM "${this.config.schema}"."accounts"
       ORDER BY _last_synced_at DESC`)).rows.map(e=>e._raw_data)}async getAccountIdByApiKeyHash(e){let t=await this.query(`SELECT id FROM "${this.config.schema}"."accounts"
       WHERE $1 = ANY(api_key_hashes)
       LIMIT 1`,[e]);return t.rows.length>0?t.rows[0].id:null}async getAccountRecordCounts(e){let t={};for(let i of u){let s=i.startsWith("_")?"account_id":"_account_id",r=await this.query(`SELECT COUNT(*) as count FROM "${this.config.schema}"."${i}"
         WHERE "${s}" = $1`,[e]);t[i]=parseInt(r.rows[0].count)}return t}async deleteAccountWithCascade(e,t){let i={};try{for(let s of(t&&await this.query("BEGIN"),u)){let t=s.startsWith("_")?"account_id":"_account_id",r=await this.query(`DELETE FROM "${this.config.schema}"."${s}"
           WHERE "${t}" = $1`,[e]);i[s]=r.rowCount||0}i.accounts=(await this.query(`DELETE FROM "${this.config.schema}"."accounts"
         WHERE "id" = $1`,[e])).rowCount||0,t&&await this.query("COMMIT")}catch(e){throw t&&await this.query("ROLLBACK"),e}return i}hashToInt32(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t&=t;return t}async acquireAdvisoryLock(e){let t=this.hashToInt32(e);await this.query("SELECT pg_advisory_lock($1)",[t])}async releaseAdvisoryLock(e){let t=this.hashToInt32(e);await this.query("SELECT pg_advisory_unlock($1)",[t])}async withAdvisoryLock(e,t){let i=this.hashToInt32(e),s=await this.pool.connect();try{return await s.query("SELECT pg_advisory_lock($1)",[i]),await t()}finally{try{await s.query("SELECT pg_advisory_unlock($1)",[i])}finally{s.release()}}}},p=["id","object","url","enabled_events","description","enabled","livemode","metadata","secret","status","api_version","created","account_id"],f={maxRetries:5,initialDelayMs:1e3,maxDelayMs:6e4,jitterMs:500};function m(e){return e instanceof t.default.errors.StripeRateLimitError?"rate_limit":e instanceof t.default.errors.StripeAPIError?`api_error_${e.statusCode}`:e instanceof t.default.errors.StripeConnectionError?"connection_error":"unknown"}async function g(e,i={},s){let r,n={...f,...i};for(let i=0;i<=n.maxRetries;i++)try{return await e()}catch(h){var a,o,c;if(r=h,!function(e){if(e instanceof t.default.errors.StripeRateLimitError)return!0;if(e instanceof t.default.errors.StripeAPIError){let t=e.statusCode;if(t&&[500,502,503,504,424].includes(t))return!0}return e instanceof t.default.errors.StripeConnectionError}(h))throw h;if(i>=n.maxRetries)throw s?.error({error:h instanceof Error?h.message:String(h),errorType:m(h),attempt:i+1,maxRetries:n.maxRetries},"Max retries exhausted for Stripe error"),h;let e=function(e){if(!(e instanceof t.default.errors.StripeRateLimitError))return null;let i=e.headers?.["retry-after"];if(!i)return null;let s=Number(i);return isNaN(s)||s<=0?null:1e3*s}(h),l=(a=i,o=n,null!=(c=e)?c+Math.random()*o.jitterMs:Math.min(o.initialDelayMs*Math.pow(2,a),o.maxDelayMs)+Math.random()*o.jitterMs);s?.warn({error:h instanceof Error?h.message:String(h),errorType:m(h),attempt:i+1,maxRetries:n.maxRetries,delayMs:Math.round(l),retryAfterMs:e??void 0,nextAttempt:i+2},"Transient Stripe error, retrying after delay"),await function(e){return new Promise(t=>setTimeout(t,e))}(l)}throw r}function y(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then}function b(e){return(0,a.createHash)("sha256").update(e).digest("hex")}function w(e,t){return Array.from(new Set(e.map(e=>e?.[t]?.toString()).filter(e=>!!e)))}var _=class{constructor(e){this.config=e;const i=new t.default(e.stripeSecretKey,{apiVersion:e.stripeApiVersion,appInfo:{name:"Stripe Postgres Sync"}});this.stripe=function(e,t={},i){return"true"===process.env.VITEST||void 0!==process.env.JEST_WORKER_ID?e:new Proxy(e,{get(e,s,r){let n=Reflect.get(e,s,r);return n&&"object"==typeof n&&!y(n)?function e(t,i,s){return new Proxy(t,{get(t,r,n){let a=Reflect.get(t,r,n);return"function"==typeof a?function(...e){let r=a.apply(t,e);return r&&"object"==typeof r&&Symbol.asyncIterator in r?r:y(r)?g(()=>Promise.resolve(r),i,s):r}:a&&"object"==typeof a&&!y(a)?e(a,i,s):a}})}(n,t,i):n}})}(i,{},e.logger),this.config.logger=e.logger??console,this.config.logger?.info({autoExpandLists:e.autoExpandLists,stripeApiVersion:e.stripeApiVersion},"StripeSync initialized");const s=e.poolConfig??{};e.databaseUrl&&(s.connectionString=e.databaseUrl),e.maxPostgresConnections&&(s.max=e.maxPostgresConnections),void 0===s.max&&(s.max=10),void 0===s.keepAlive&&(s.keepAlive=!0),this.postgresClient=new d({schema:"stripe",poolConfig:s})}stripe;postgresClient;cachedAccount=null;async getAccountId(e){let t;if(this.cachedAccount?.id)return this.cachedAccount.id;let i=b(this.config.stripeSecretKey);try{let e=await this.postgresClient.getAccountIdByApiKeyHash(i);if(e)return e}catch(e){this.config.logger?.warn(e,"Failed to lookup account by API key hash, falling back to API")}try{let i=e||this.config.stripeAccountId;t=i?await this.stripe.accounts.retrieve(i):await this.stripe.accounts.retrieve()}catch(e){throw this.config.logger?.error(e,"Failed to retrieve account from Stripe API"),Error("Failed to retrieve Stripe account. Please ensure API key is valid.")}return this.cachedAccount=t,await this.upsertAccount(t,i),t.id}async upsertAccount(e,t){try{await this.postgresClient.upsertAccount({id:e.id,raw_data:e},t)}catch(t){this.config.logger?.error(t,"Failed to upsert account to database");let e=t instanceof Error?t.message:"Unknown error";throw Error(`Failed to upsert account to database: ${e}`)}}async getCurrentAccount(){return this.cachedAccount||await this.getAccountId(),this.cachedAccount}async getAllSyncedAccounts(){try{return await this.postgresClient.getAllAccounts()}catch(e){throw this.config.logger?.error(e,"Failed to retrieve accounts from database"),Error("Failed to retrieve synced accounts from database")}}async dangerouslyDeleteSyncedAccountData(e,t){let i=t?.dryRun??!1,s=t?.useTransaction??!0;this.config.logger?.info(`${i?"Preview":"Deleting"} account ${e} (transaction: ${s})`);try{let t=await this.postgresClient.getAccountRecordCounts(e),r=[],n=0;for(let[e,i]of Object.entries(t))i>0&&(n+=i,r.push(`Will delete ${i} ${e} record${1!==i?"s":""}`));if(n>1e5&&r.push(`Large dataset detected (${n} total records). Consider using useTransaction: false for better performance.`),this.cachedAccount?.id===e&&r.push("Warning: Deleting the current account. Cache will be cleared after deletion."),i)return this.config.logger?.info(`Dry-run complete: ${n} total records would be deleted`),{deletedAccountId:e,deletedRecordCounts:t,warnings:r};let a=await this.postgresClient.deleteAccountWithCascade(e,s);return this.cachedAccount?.id===e&&(this.cachedAccount=null),this.config.logger?.info(`Successfully deleted account ${e} with ${n} total records`),{deletedAccountId:e,deletedRecordCounts:a,warnings:r}}catch(i){this.config.logger?.error(i,`Failed to delete account ${e}`);let t=i instanceof Error?i.message:"Unknown error";throw Error(`Failed to delete account ${e}: ${t}`)}}async processWebhook(e,t){let i=this.config.stripeWebhookSecret;if(!i){let e=await this.getAccountId(),t=await this.postgresClient.query('SELECT secret FROM "stripe"."_managed_webhooks" WHERE account_id = $1 LIMIT 1',[e]);t.rows.length>0&&(i=t.rows[0].secret)}if(!i)throw Error("No webhook secret provided. Either create a managed webhook or configure stripeWebhookSecret.");let s=await this.stripe.webhooks.constructEventAsync(e,t,i);return this.processEvent(s)}eventHandlers={"charge.captured":this.handleChargeEvent.bind(this),"charge.expired":this.handleChargeEvent.bind(this),"charge.failed":this.handleChargeEvent.bind(this),"charge.pending":this.handleChargeEvent.bind(this),"charge.refunded":this.handleChargeEvent.bind(this),"charge.succeeded":this.handleChargeEvent.bind(this),"charge.updated":this.handleChargeEvent.bind(this),"customer.deleted":this.handleCustomerDeletedEvent.bind(this),"customer.created":this.handleCustomerEvent.bind(this),"customer.updated":this.handleCustomerEvent.bind(this),"checkout.session.async_payment_failed":this.handleCheckoutSessionEvent.bind(this),"checkout.session.async_payment_succeeded":this.handleCheckoutSessionEvent.bind(this),"checkout.session.completed":this.handleCheckoutSessionEvent.bind(this),"checkout.session.expired":this.handleCheckoutSessionEvent.bind(this),"customer.subscription.created":this.handleSubscriptionEvent.bind(this),"customer.subscription.deleted":this.handleSubscriptionEvent.bind(this),"customer.subscription.paused":this.handleSubscriptionEvent.bind(this),"customer.subscription.pending_update_applied":this.handleSubscriptionEvent.bind(this),"customer.subscription.pending_update_expired":this.handleSubscriptionEvent.bind(this),"customer.subscription.trial_will_end":this.handleSubscriptionEvent.bind(this),"customer.subscription.resumed":this.handleSubscriptionEvent.bind(this),"customer.subscription.updated":this.handleSubscriptionEvent.bind(this),"customer.tax_id.updated":this.handleTaxIdEvent.bind(this),"customer.tax_id.created":this.handleTaxIdEvent.bind(this),"customer.tax_id.deleted":this.handleTaxIdDeletedEvent.bind(this),"invoice.created":this.handleInvoiceEvent.bind(this),"invoice.deleted":this.handleInvoiceEvent.bind(this),"invoice.finalized":this.handleInvoiceEvent.bind(this),"invoice.finalization_failed":this.handleInvoiceEvent.bind(this),"invoice.paid":this.handleInvoiceEvent.bind(this),"invoice.payment_action_required":this.handleInvoiceEvent.bind(this),"invoice.payment_failed":this.handleInvoiceEvent.bind(this),"invoice.payment_succeeded":this.handleInvoiceEvent.bind(this),"invoice.upcoming":this.handleInvoiceEvent.bind(this),"invoice.sent":this.handleInvoiceEvent.bind(this),"invoice.voided":this.handleInvoiceEvent.bind(this),"invoice.marked_uncollectible":this.handleInvoiceEvent.bind(this),"invoice.updated":this.handleInvoiceEvent.bind(this),"product.created":this.handleProductEvent.bind(this),"product.updated":this.handleProductEvent.bind(this),"product.deleted":this.handleProductDeletedEvent.bind(this),"price.created":this.handlePriceEvent.bind(this),"price.updated":this.handlePriceEvent.bind(this),"price.deleted":this.handlePriceDeletedEvent.bind(this),"plan.created":this.handlePlanEvent.bind(this),"plan.updated":this.handlePlanEvent.bind(this),"plan.deleted":this.handlePlanDeletedEvent.bind(this),"setup_intent.canceled":this.handleSetupIntentEvent.bind(this),"setup_intent.created":this.handleSetupIntentEvent.bind(this),"setup_intent.requires_action":this.handleSetupIntentEvent.bind(this),"setup_intent.setup_failed":this.handleSetupIntentEvent.bind(this),"setup_intent.succeeded":this.handleSetupIntentEvent.bind(this),"subscription_schedule.aborted":this.handleSubscriptionScheduleEvent.bind(this),"subscription_schedule.canceled":this.handleSubscriptionScheduleEvent.bind(this),"subscription_schedule.completed":this.handleSubscriptionScheduleEvent.bind(this),"subscription_schedule.created":this.handleSubscriptionScheduleEvent.bind(this),"subscription_schedule.expiring":this.handleSubscriptionScheduleEvent.bind(this),"subscription_schedule.released":this.handleSubscriptionScheduleEvent.bind(this),"subscription_schedule.updated":this.handleSubscriptionScheduleEvent.bind(this),"payment_method.attached":this.handlePaymentMethodEvent.bind(this),"payment_method.automatically_updated":this.handlePaymentMethodEvent.bind(this),"payment_method.detached":this.handlePaymentMethodEvent.bind(this),"payment_method.updated":this.handlePaymentMethodEvent.bind(this),"charge.dispute.created":this.handleDisputeEvent.bind(this),"charge.dispute.funds_reinstated":this.handleDisputeEvent.bind(this),"charge.dispute.funds_withdrawn":this.handleDisputeEvent.bind(this),"charge.dispute.updated":this.handleDisputeEvent.bind(this),"charge.dispute.closed":this.handleDisputeEvent.bind(this),"payment_intent.amount_capturable_updated":this.handlePaymentIntentEvent.bind(this),"payment_intent.canceled":this.handlePaymentIntentEvent.bind(this),"payment_intent.created":this.handlePaymentIntentEvent.bind(this),"payment_intent.partially_funded":this.handlePaymentIntentEvent.bind(this),"payment_intent.payment_failed":this.handlePaymentIntentEvent.bind(this),"payment_intent.processing":this.handlePaymentIntentEvent.bind(this),"payment_intent.requires_action":this.handlePaymentIntentEvent.bind(this),"payment_intent.succeeded":this.handlePaymentIntentEvent.bind(this),"credit_note.created":this.handleCreditNoteEvent.bind(this),"credit_note.updated":this.handleCreditNoteEvent.bind(this),"credit_note.voided":this.handleCreditNoteEvent.bind(this),"radar.early_fraud_warning.created":this.handleEarlyFraudWarningEvent.bind(this),"radar.early_fraud_warning.updated":this.handleEarlyFraudWarningEvent.bind(this),"refund.created":this.handleRefundEvent.bind(this),"refund.failed":this.handleRefundEvent.bind(this),"refund.updated":this.handleRefundEvent.bind(this),"charge.refund.updated":this.handleRefundEvent.bind(this),"review.closed":this.handleReviewEvent.bind(this),"review.opened":this.handleReviewEvent.bind(this),"entitlements.active_entitlement_summary.updated":this.handleEntitlementSummaryEvent.bind(this)};async processEvent(e){let t=e.data?.object&&"object"==typeof e.data.object&&"account"in e.data.object?e.data.object.account:void 0,i=await this.getAccountId(t);await this.getCurrentAccount();let s=this.eventHandlers[e.type];if(s){let t=e.data?.object&&"object"==typeof e.data.object&&"id"in e.data.object?e.data.object.id:"unknown";this.config.logger?.info(`Received webhook ${e.id}: ${e.type} for ${t}`),await s(e,i)}else this.config.logger?.warn(`Received unhandled webhook event: ${e.type} (${e.id}). Ignoring.`)}getSupportedEventTypes(){return Object.keys(this.eventHandlers).sort()}async handleChargeEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.charges.retrieve(e),e=>"failed"===e.status||"succeeded"===e.status);await this.upsertCharges([i],t,!1,this.getSyncTimestamp(e,s))}async handleCustomerDeletedEvent(e,t){let i={id:e.data.object.id,object:"customer",deleted:!0};await this.upsertCustomers([i],t,this.getSyncTimestamp(e,!1))}async handleCustomerEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.customers.retrieve(e),e=>!0===e.deleted);await this.upsertCustomers([i],t,this.getSyncTimestamp(e,s))}async handleCheckoutSessionEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.checkout.sessions.retrieve(e));await this.upsertCheckoutSessions([i],t,!1,this.getSyncTimestamp(e,s))}async handleSubscriptionEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.subscriptions.retrieve(e),e=>"canceled"===e.status||"incomplete_expired"===e.status);await this.upsertSubscriptions([i],t,!1,this.getSyncTimestamp(e,s))}async handleTaxIdEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.taxIds.retrieve(e));await this.upsertTaxIds([i],t,!1,this.getSyncTimestamp(e,s))}async handleTaxIdDeletedEvent(e,t){let i=e.data.object;await this.deleteTaxId(i.id)}async handleInvoiceEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.invoices.retrieve(e),e=>"void"===e.status);await this.upsertInvoices([i],t,!1,this.getSyncTimestamp(e,s))}async handleProductEvent(e,i){try{let{entity:t,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.products.retrieve(e));await this.upsertProducts([t],i,this.getSyncTimestamp(e,s))}catch(i){if(i instanceof t.default.errors.StripeAPIError&&"resource_missing"===i.code){let t=e.data.object;await this.deleteProduct(t.id)}else throw i}}async handleProductDeletedEvent(e,t){let i=e.data.object;await this.deleteProduct(i.id)}async handlePriceEvent(e,i){try{let{entity:t,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.prices.retrieve(e));await this.upsertPrices([t],i,!1,this.getSyncTimestamp(e,s))}catch(i){if(i instanceof t.default.errors.StripeAPIError&&"resource_missing"===i.code){let t=e.data.object;await this.deletePrice(t.id)}else throw i}}async handlePriceDeletedEvent(e,t){let i=e.data.object;await this.deletePrice(i.id)}async handlePlanEvent(e,i){try{let{entity:t,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.plans.retrieve(e));await this.upsertPlans([t],i,!1,this.getSyncTimestamp(e,s))}catch(i){if(i instanceof t.default.errors.StripeAPIError&&"resource_missing"===i.code){let t=e.data.object;await this.deletePlan(t.id)}else throw i}}async handlePlanDeletedEvent(e,t){let i=e.data.object;await this.deletePlan(i.id)}async handleSetupIntentEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.setupIntents.retrieve(e),e=>"canceled"===e.status||"succeeded"===e.status);await this.upsertSetupIntents([i],t,!1,this.getSyncTimestamp(e,s))}async handleSubscriptionScheduleEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.subscriptionSchedules.retrieve(e),e=>"canceled"===e.status||"completed"===e.status);await this.upsertSubscriptionSchedules([i],t,!1,this.getSyncTimestamp(e,s))}async handlePaymentMethodEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.paymentMethods.retrieve(e));await this.upsertPaymentMethods([i],t,!1,this.getSyncTimestamp(e,s))}async handleDisputeEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.disputes.retrieve(e),e=>"won"===e.status||"lost"===e.status);await this.upsertDisputes([i],t,!1,this.getSyncTimestamp(e,s))}async handlePaymentIntentEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.paymentIntents.retrieve(e),e=>"canceled"===e.status||"succeeded"===e.status);await this.upsertPaymentIntents([i],t,!1,this.getSyncTimestamp(e,s))}async handleCreditNoteEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.creditNotes.retrieve(e),e=>"void"===e.status);await this.upsertCreditNotes([i],t,!1,this.getSyncTimestamp(e,s))}async handleEarlyFraudWarningEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.radar.earlyFraudWarnings.retrieve(e));await this.upsertEarlyFraudWarning([i],t,!1,this.getSyncTimestamp(e,s))}async handleRefundEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.refunds.retrieve(e));await this.upsertRefunds([i],t,!1,this.getSyncTimestamp(e,s))}async handleReviewEvent(e,t){let{entity:i,refetched:s}=await this.fetchOrUseWebhookData(e.data.object,e=>this.stripe.reviews.retrieve(e));await this.upsertReviews([i],t,!1,this.getSyncTimestamp(e,s))}async handleEntitlementSummaryEvent(e,t){let i=e.data.object,s=i.entitlements,r=!1;if(this.config.revalidateObjectsViaStripeApi?.includes("entitlements")){let{lastResponse:e,...t}=await this.stripe.entitlements.activeEntitlements.list({customer:i.customer});s=t,r=!0}await this.deleteRemovedActiveEntitlements(i.customer,s.data.map(e=>e.id)),await this.upsertActiveEntitlements(i.customer,s.data,t,!1,this.getSyncTimestamp(e,r))}getSyncTimestamp(e,t){return t?new Date().toISOString():new Date(1e3*e.created).toISOString()}shouldRefetchEntity(e){return this.config.revalidateObjectsViaStripeApi?.includes(e.object)}async fetchOrUseWebhookData(e,t,i){return!e.id||i&&i(e)?{entity:e,refetched:!1}:this.shouldRefetchEntity(e)?{entity:await t(e.id),refetched:!0}:{entity:e,refetched:!1}}async syncSingleEntity(e){let t=await this.getAccountId();if(e.startsWith("cus_"))return this.stripe.customers.retrieve(e).then(e=>{if(e&&!e.deleted)return this.upsertCustomers([e],t)});if(e.startsWith("in_"))return this.stripe.invoices.retrieve(e).then(e=>this.upsertInvoices([e],t));if(e.startsWith("price_"))return this.stripe.prices.retrieve(e).then(e=>this.upsertPrices([e],t));if(e.startsWith("prod_"))return this.stripe.products.retrieve(e).then(e=>this.upsertProducts([e],t));if(e.startsWith("sub_"))return this.stripe.subscriptions.retrieve(e).then(e=>this.upsertSubscriptions([e],t));else if(e.startsWith("seti_"))return this.stripe.setupIntents.retrieve(e).then(e=>this.upsertSetupIntents([e],t));else if(e.startsWith("pm_"))return this.stripe.paymentMethods.retrieve(e).then(e=>this.upsertPaymentMethods([e],t));else if(e.startsWith("dp_")||e.startsWith("du_"))return this.stripe.disputes.retrieve(e).then(e=>this.upsertDisputes([e],t));else if(e.startsWith("ch_"))return this.stripe.charges.retrieve(e).then(e=>this.upsertCharges([e],t,!0));else if(e.startsWith("pi_"))return this.stripe.paymentIntents.retrieve(e).then(e=>this.upsertPaymentIntents([e],t));else if(e.startsWith("txi_"))return this.stripe.taxIds.retrieve(e).then(e=>this.upsertTaxIds([e],t));else if(e.startsWith("cn_"))return this.stripe.creditNotes.retrieve(e).then(e=>this.upsertCreditNotes([e],t));else if(e.startsWith("issfr_"))return this.stripe.radar.earlyFraudWarnings.retrieve(e).then(e=>this.upsertEarlyFraudWarning([e],t));else if(e.startsWith("prv_"))return this.stripe.reviews.retrieve(e).then(e=>this.upsertReviews([e],t));else if(e.startsWith("re_"))return this.stripe.refunds.retrieve(e).then(e=>this.upsertRefunds([e],t));else if(e.startsWith("feat_"))return this.stripe.entitlements.features.retrieve(e).then(e=>this.upsertFeatures([e],t));else if(e.startsWith("cs_"))return this.stripe.checkout.sessions.retrieve(e).then(e=>this.upsertCheckoutSessions([e],t))}async syncBackfill(e){let t,i,s,r,n,a,o,c,l,h,u,d,p,f,m,g,y,{object:b}=e??{object:this.getSupportedEventTypes};switch(await this.getCurrentAccount(),b){case"all":t=await this.syncProducts(e),i=await this.syncPrices(e),p=await this.syncPlans(e),s=await this.syncCustomers(e),n=await this.syncSubscriptions(e),a=await this.syncSubscriptionSchedules(e),o=await this.syncInvoices(e),u=await this.syncCharges(e),c=await this.syncSetupIntents(e),l=await this.syncPaymentMethods(e),d=await this.syncPaymentIntents(e),f=await this.syncTaxIds(e),m=await this.syncCreditNotes(e),h=await this.syncDisputes(e),g=await this.syncEarlyFraudWarnings(e),y=await this.syncRefunds(e),r=await this.syncCheckoutSessions(e);break;case"customer":s=await this.syncCustomers(e);break;case"invoice":o=await this.syncInvoices(e);break;case"price":i=await this.syncPrices(e);break;case"product":t=await this.syncProducts(e);break;case"subscription":n=await this.syncSubscriptions(e);break;case"subscription_schedules":a=await this.syncSubscriptionSchedules(e);break;case"setup_intent":c=await this.syncSetupIntents(e);break;case"payment_method":l=await this.syncPaymentMethods(e);break;case"dispute":h=await this.syncDisputes(e);break;case"charge":u=await this.syncCharges(e);break;case"payment_intent":d=await this.syncPaymentIntents(e);case"plan":p=await this.syncPlans(e);break;case"tax_id":f=await this.syncTaxIds(e);break;case"credit_note":m=await this.syncCreditNotes(e);break;case"early_fraud_warning":g=await this.syncEarlyFraudWarnings(e);break;case"refund":y=await this.syncRefunds(e);break;case"checkout_sessions":r=await this.syncCheckoutSessions(e)}return{products:t,prices:i,customers:s,checkoutSessions:r,subscriptions:n,subscriptionSchedules:a,invoices:o,setupIntents:c,paymentMethods:l,disputes:h,charges:u,paymentIntents:d,plans:p,taxIds:f,creditNotes:m,earlyFraudWarnings:g,refunds:y}}async syncProducts(e){this.config.logger?.info("Syncing products");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("products",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.products.list(i),e=>this.upsertProducts(e,t),t,"products")}async syncPrices(e){this.config.logger?.info("Syncing prices");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("prices",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.prices.list(i),i=>this.upsertPrices(i,t,e?.backfillRelatedEntities),t,"prices")}async syncPlans(e){this.config.logger?.info("Syncing plans");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("plans",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.plans.list(i),i=>this.upsertPlans(i,t,e?.backfillRelatedEntities),t,"plans")}async syncCustomers(e){this.config.logger?.info("Syncing customers");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("customers",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.customers.list(i),e=>this.upsertCustomers(e,t),t,"customers")}async syncSubscriptions(e){this.config.logger?.info("Syncing subscriptions");let t=await this.getAccountId(),i={status:"all",limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("subscriptions",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.subscriptions.list(i),i=>this.upsertSubscriptions(i,t,e?.backfillRelatedEntities),t,"subscriptions")}async syncSubscriptionSchedules(e){this.config.logger?.info("Syncing subscription schedules");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("subscription_schedules",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.subscriptionSchedules.list(i),i=>this.upsertSubscriptionSchedules(i,t,e?.backfillRelatedEntities),t,"subscription_schedules")}async syncInvoices(e){this.config.logger?.info("Syncing invoices");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("invoices",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.invoices.list(i),i=>this.upsertInvoices(i,t,e?.backfillRelatedEntities),t,"invoices")}async syncCharges(e){this.config.logger?.info("Syncing charges");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("charges",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.charges.list(i),i=>this.upsertCharges(i,t,e?.backfillRelatedEntities),t,"charges")}async syncSetupIntents(e){this.config.logger?.info("Syncing setup_intents");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("setup_intents",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.setupIntents.list(i),i=>this.upsertSetupIntents(i,t,e?.backfillRelatedEntities),t,"setup_intents")}async syncPaymentIntents(e){this.config.logger?.info("Syncing payment_intents");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("payment_intents",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.paymentIntents.list(i),i=>this.upsertPaymentIntents(i,t,e?.backfillRelatedEntities),t,"payment_intents")}async syncTaxIds(e){this.config.logger?.info("Syncing tax_ids");let t=await this.getAccountId(),i={limit:100};return this.fetchAndUpsert(()=>this.stripe.taxIds.list(i),i=>this.upsertTaxIds(i,t,e?.backfillRelatedEntities),t)}async syncPaymentMethods(e){this.config.logger?.info("Syncing payment method");let t=await this.getAccountId(),s=(0,i.pg)('select id from "stripe"."customers" WHERE COALESCE(deleted, false) <> true;')([]),r=await this.postgresClient.query(s.text,s.values).then(({rows:e})=>e.map(e=>e.id));this.config.logger?.info(`Getting payment methods for ${r.length} customers`);let n=0;for(let i of function(e,t){let i=[];for(let t=0;t<e.length;t+=10)i.push(e.slice(t,t+10));return i}(r,10))await Promise.all(i.map(async i=>{let s=await this.fetchAndUpsert(()=>this.stripe.paymentMethods.list({limit:100,customer:i}),i=>this.upsertPaymentMethods(i,t,e?.backfillRelatedEntities),t);n+=s.synced}));return{synced:n}}async syncDisputes(e){this.config.logger?.info("Syncing disputes");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("disputes",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.disputes.list(i),i=>this.upsertDisputes(i,t,e?.backfillRelatedEntities),t,"disputes")}async syncEarlyFraudWarnings(e){this.config.logger?.info("Syncing early fraud warnings");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("early_fraud_warnings",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.radar.earlyFraudWarnings.list(i),i=>this.upsertEarlyFraudWarning(i,t,e?.backfillRelatedEntities),t,"early_fraud_warnings")}async syncRefunds(e){this.config.logger?.info("Syncing refunds");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("refunds",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.refunds.list(i),i=>this.upsertRefunds(i,t,e?.backfillRelatedEntities),t,"refunds")}async syncCreditNotes(e){this.config.logger?.info("Syncing credit notes");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("credit_notes",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.creditNotes.list(i),e=>this.upsertCreditNotes(e,t),t,"credit_notes")}async syncFeatures(e){this.config.logger?.info("Syncing features");let t=await this.getAccountId(),i={limit:100,...e?.pagination};return this.fetchAndUpsert(()=>this.stripe.entitlements.features.list(i),e=>this.upsertFeatures(e,t),t)}async syncEntitlements(e,t){this.config.logger?.info("Syncing entitlements");let i=await this.getAccountId(),s={customer:e,limit:100,...t?.pagination};return this.fetchAndUpsert(()=>this.stripe.entitlements.activeEntitlements.list(s),t=>this.upsertActiveEntitlements(e,t,i),i)}async syncCheckoutSessions(e){this.config.logger?.info("Syncing checkout sessions");let t=await this.getAccountId(),i={limit:100};if(e?.created)i.created=e.created;else{let e=await this.postgresClient.getSyncCursor("checkout_sessions",t);e&&(i.created={gte:e},this.config.logger?.info(`Incremental sync from cursor: ${e}`))}return this.fetchAndUpsert(()=>this.stripe.checkout.sessions.list(i),i=>this.upsertCheckoutSessions(i,t,e?.backfillRelatedEntities),t,"checkout_sessions")}async fetchAndUpsert(e,t,i,s){let r=0,n=[];s&&await this.postgresClient.markSyncRunning(s,i);try{this.config.logger?.info("Fetching items to sync from Stripe");try{for await(let a of e())if(n.push(a),n.length>=100){if(this.config.logger?.info(`Upserting batch of ${n.length} items`),await t(n,i),r+=n.length,s){let e=Math.max(...n.map(e=>e.created||0));e>0&&(await this.postgresClient.updateSyncCursor(s,i,e),this.config.logger?.info(`Checkpoint: cursor updated to ${e}`))}n=[]}if(n.length>0&&(this.config.logger?.info(`Upserting final batch of ${n.length} items`),await t(n,i),r+=n.length,s)){let e=Math.max(...n.map(e=>e.created||0));e>0&&await this.postgresClient.updateSyncCursor(s,i,e)}}catch(e){if(n.length>0&&(this.config.logger?.info(`Error occurred, saving partial progress: ${n.length} items`),await t(n,i),r+=n.length,s)){let e=Math.max(...n.map(e=>e.created||0));e>0&&await this.postgresClient.updateSyncCursor(s,i,e)}throw e}return s&&await this.postgresClient.markSyncComplete(s,i),this.config.logger?.info(`Sync complete: ${r} items synced`),{synced:r}}catch(e){throw s&&await this.postgresClient.markSyncError(s,i,e instanceof Error?e.message:"Unknown error"),e}}async upsertCharges(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillCustomers(w(e,"customer"),t),this.backfillInvoices(w(e,"invoice"),t)]),await this.expandEntity(e,"refunds",e=>this.stripe.refunds.list({charge:e,limit:100})),this.postgresClient.upsertManyWithTimestampProtection(e,"charges",t,s)}async backfillCharges(e,t){let i=await this.postgresClient.findMissingEntries("charges",e);await this.fetchMissingEntities(i,e=>this.stripe.charges.retrieve(e)).then(e=>this.upsertCharges(e,t))}async backfillPaymentIntents(e,t){let i=await this.postgresClient.findMissingEntries("payment_intents",e);await this.fetchMissingEntities(i,e=>this.stripe.paymentIntents.retrieve(e)).then(e=>this.upsertPaymentIntents(e,t))}async upsertCreditNotes(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillCustomers(w(e,"customer"),t),this.backfillInvoices(w(e,"invoice"),t)]),await this.expandEntity(e,"lines",e=>this.stripe.creditNotes.listLineItems(e,{limit:100})),this.postgresClient.upsertManyWithTimestampProtection(e,"credit_notes",t,s)}async upsertCheckoutSessions(e,t,i,s){(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillCustomers(w(e,"customer"),t),this.backfillSubscriptions(w(e,"subscription"),t),this.backfillPaymentIntents(w(e,"payment_intent"),t),this.backfillInvoices(w(e,"invoice"),t)]);let r=await this.postgresClient.upsertManyWithTimestampProtection(e,"checkout_sessions",t,s);return await this.fillCheckoutSessionsLineItems(e.map(e=>e.id),t,s),r}async upsertEarlyFraudWarning(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillPaymentIntents(w(e,"payment_intent"),t),this.backfillCharges(w(e,"charge"),t)]),this.postgresClient.upsertManyWithTimestampProtection(e,"early_fraud_warnings",t,s)}async upsertRefunds(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillPaymentIntents(w(e,"payment_intent"),t),this.backfillCharges(w(e,"charge"),t)]),this.postgresClient.upsertManyWithTimestampProtection(e,"refunds",t,s)}async upsertReviews(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillPaymentIntents(w(e,"payment_intent"),t),this.backfillCharges(w(e,"charge"),t)]),this.postgresClient.upsertManyWithTimestampProtection(e,"reviews",t,s)}async upsertCustomers(e,t,i){let s=e.filter(e=>e.deleted),r=e.filter(e=>!e.deleted);return await this.postgresClient.upsertManyWithTimestampProtection(r,"customers",t,i),await this.postgresClient.upsertManyWithTimestampProtection(s,"customers",t,i),e}async backfillCustomers(e,t){let i=await this.postgresClient.findMissingEntries("customers",e);await this.fetchMissingEntities(i,e=>this.stripe.customers.retrieve(e)).then(e=>this.upsertCustomers(e,t)).catch(e=>{throw this.config.logger?.error(e,"Failed to backfill"),e})}async upsertDisputes(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await this.backfillCharges(w(e,"charge"),t),this.postgresClient.upsertManyWithTimestampProtection(e,"disputes",t,s)}async upsertInvoices(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillCustomers(w(e,"customer"),t),this.backfillSubscriptions(w(e,"subscription"),t)]),await this.expandEntity(e,"lines",e=>this.stripe.invoices.listLineItems(e,{limit:100})),this.postgresClient.upsertManyWithTimestampProtection(e,"invoices",t,s)}backfillInvoices=async(e,t)=>{let i=await this.postgresClient.findMissingEntries("invoices",e);await this.fetchMissingEntities(i,e=>this.stripe.invoices.retrieve(e)).then(e=>this.upsertInvoices(e,t))};backfillPrices=async(e,t)=>{let i=await this.postgresClient.findMissingEntries("prices",e);await this.fetchMissingEntities(i,e=>this.stripe.prices.retrieve(e)).then(e=>this.upsertPrices(e,t))};async upsertPlans(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await this.backfillProducts(w(e,"product"),t),this.postgresClient.upsertManyWithTimestampProtection(e,"plans",t,s)}async deletePlan(e){return this.postgresClient.delete("plans",e)}async upsertPrices(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await this.backfillProducts(w(e,"product"),t),this.postgresClient.upsertManyWithTimestampProtection(e,"prices",t,s)}async deletePrice(e){return this.postgresClient.delete("prices",e)}async upsertProducts(e,t,i){return this.postgresClient.upsertManyWithTimestampProtection(e,"products",t,i)}async deleteProduct(e){return this.postgresClient.delete("products",e)}async backfillProducts(e,t){let i=await this.postgresClient.findMissingEntries("products",e);await this.fetchMissingEntities(i,e=>this.stripe.products.retrieve(e)).then(e=>this.upsertProducts(e,t))}async upsertPaymentIntents(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillCustomers(w(e,"customer"),t),this.backfillInvoices(w(e,"invoice"),t)]),this.postgresClient.upsertManyWithTimestampProtection(e,"payment_intents",t,s)}async upsertPaymentMethods(e,t,i=!1,s){return(i??this.config.backfillRelatedEntities)&&await this.backfillCustomers(w(e,"customer"),t),this.postgresClient.upsertManyWithTimestampProtection(e,"payment_methods",t,s)}async upsertSetupIntents(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await this.backfillCustomers(w(e,"customer"),t),this.postgresClient.upsertManyWithTimestampProtection(e,"setup_intents",t,s)}async upsertTaxIds(e,t,i,s){return(i??this.config.backfillRelatedEntities)&&await this.backfillCustomers(w(e,"customer"),t),this.postgresClient.upsertManyWithTimestampProtection(e,"tax_ids",t,s)}async deleteTaxId(e){return this.postgresClient.delete("tax_ids",e)}async upsertSubscriptionItems(e,t,i){let s=e.map(e=>{let t=e.price.id.toString(),i=e.deleted,s=e.quantity;return{...e,price:t,deleted:i??!1,quantity:s??null}});await this.postgresClient.upsertManyWithTimestampProtection(s,"subscription_items",t,i)}async fillCheckoutSessionsLineItems(e,t,i){for(let s of e){let e=[];for await(let t of this.stripe.checkout.sessions.listLineItems(s,{limit:100}))e.push(t);await this.upsertCheckoutSessionLineItems(e,s,t,i)}}async upsertCheckoutSessionLineItems(e,t,i,s){await this.backfillPrices(e.map(e=>e.price?.id?.toString()??void 0).filter(e=>void 0!==e),i);let r=e.map(e=>{let i="object"==typeof e.price&&e.price?.id?e.price.id.toString():e.price?.toString()||null;return{...e,price:i,checkout_session:t}});await this.postgresClient.upsertManyWithTimestampProtection(r,"checkout_session_line_items",i,s)}async markDeletedSubscriptionItems(e,t){let s=(0,i.pg)(`
    select id from "stripe"."subscription_items"
    where subscription = :subscriptionId and COALESCE(deleted, false) = false;
    `)({subscriptionId:e}),{rows:r}=await this.postgresClient.query(s.text,s.values),n=r.filter(({id:e})=>!1===t.includes(e));if(!(n.length>0))return{rowCount:0};{let e=n.map(({id:e})=>e);s=(0,i.pg)(`
      update "stripe"."subscription_items"
      set _raw_data = jsonb_set(_raw_data, '{deleted}', 'true'::jsonb)
      where id=any(:ids::text[]);
      `)({ids:e});let{rowCount:t}=await this.postgresClient.query(s.text,s.values);return{rowCount:t||0}}}async upsertSubscriptionSchedules(e,t,i,s){if(i??this.config.backfillRelatedEntities){let i=w(e,"customer");await this.backfillCustomers(i,t)}return await this.postgresClient.upsertManyWithTimestampProtection(e,"subscription_schedules",t,s)}async upsertSubscriptions(e,t,i,s){if(i??this.config.backfillRelatedEntities){let i=w(e,"customer");await this.backfillCustomers(i,t)}await this.expandEntity(e,"items",e=>this.stripe.subscriptionItems.list({subscription:e,limit:100}));let r=await this.postgresClient.upsertManyWithTimestampProtection(e,"subscriptions",t,s),n=e.flatMap(e=>e.items.data);await this.upsertSubscriptionItems(n,t,s);let a=[];for(let t of e){let e=t.items.data.map(e=>e.id);a.push(this.markDeletedSubscriptionItems(t.id,e))}return await Promise.all(a),r}async deleteRemovedActiveEntitlements(e,t){let s=(0,i.pg)(`
      delete from "stripe"."active_entitlements"
      where customer = :customerId and id <> ALL(:currentActiveEntitlementIds::text[]);
      `)({customerId:e,currentActiveEntitlementIds:t}),{rowCount:r}=await this.postgresClient.query(s.text,s.values);return{rowCount:r||0}}async upsertFeatures(e,t,i){return this.postgresClient.upsertManyWithTimestampProtection(e,"features",t,i)}async backfillFeatures(e,t){let i=await this.postgresClient.findMissingEntries("features",e);await this.fetchMissingEntities(i,e=>this.stripe.entitlements.features.retrieve(e)).then(e=>this.upsertFeatures(e,t)).catch(e=>{throw this.config.logger?.error(e,"Failed to backfill features"),e})}async upsertActiveEntitlements(e,t,i,s,r){(s??this.config.backfillRelatedEntities)&&await Promise.all([this.backfillCustomers(w(t,"customer"),i),this.backfillFeatures(w(t,"feature"),i)]);let n=t.map(t=>({id:t.id,object:t.object,feature:"string"==typeof t.feature?t.feature:t.feature.id,customer:e,livemode:t.livemode,lookup_key:t.lookup_key}));return this.postgresClient.upsertManyWithTimestampProtection(n,"active_entitlements",i,r)}async findOrCreateManagedWebhook(e,t){let i={enabled_events:this.getSupportedEventTypes(),...t},s=await this.getAccountId(),r=`webhook:${s}:${e}`;return this.postgresClient.withAdvisoryLock(r,async()=>{let t=await this.getManagedWebhookByUrl(e);if(t)try{let e=await this.stripe.webhookEndpoints.retrieve(t.id);if("enabled"===e.status)return e;this.config.logger?.info({webhookId:t.id},"Webhook is disabled, deleting and will recreate"),await this.stripe.webhookEndpoints.del(t.id),await this.postgresClient.delete("_managed_webhooks",t.id)}catch(e){if(e?.statusCode===404||e?.code==="resource_missing")this.config.logger?.warn({error:e,webhookId:t.id},"Webhook not found in Stripe (404), removing from database"),await this.postgresClient.delete("_managed_webhooks",t.id);else throw this.config.logger?.error({error:e,webhookId:t.id},"Error retrieving webhook from Stripe, keeping in database"),e}let s=await this.listManagedWebhooks();for(let t of s)if(t.url!==e){this.config.logger?.info({webhookId:t.id,oldUrl:t.url,newUrl:e},"Webhook URL mismatch, deleting");try{await this.stripe.webhookEndpoints.del(t.id)}catch(e){this.config.logger?.warn({error:e,webhookId:t.id},"Failed to delete old webhook from Stripe")}await this.postgresClient.delete("_managed_webhooks",t.id)}try{for(let e of(await this.stripe.webhookEndpoints.list({limit:100})).data){let t=e.metadata?.managed_by?.toLowerCase().replace(/[\s\-]+/g,"")==="stripesync",i=(e.description?.toLowerCase().replace(/[\s\-]+/g,"")||"").includes("stripesync");(t||i)&&(s.some(t=>t.id===e.id)||(this.config.logger?.warn({webhookId:e.id,url:e.url},"Found orphaned managed webhook in Stripe, deleting"),await this.stripe.webhookEndpoints.del(e.id)))}}catch(e){this.config.logger?.warn({error:e},"Failed to check for orphaned webhooks")}let r=await this.stripe.webhookEndpoints.create({...i,url:e,metadata:{...i.metadata,managed_by:"stripe-sync"}}),n=await this.getAccountId();return await this.upsertManagedWebhooks([r],n),r})}async getManagedWebhook(e){let t=await this.getAccountId(),i=await this.postgresClient.query('SELECT * FROM "stripe"."_managed_webhooks" WHERE id = $1 AND "account_id" = $2',[e,t]);return i.rows.length>0?i.rows[0]:null}async getManagedWebhookByUrl(e){let t=await this.getAccountId(),i=await this.postgresClient.query('SELECT * FROM "stripe"."_managed_webhooks" WHERE url = $1 AND "account_id" = $2',[e,t]);return i.rows.length>0?i.rows[0]:null}async listManagedWebhooks(){let e=await this.getAccountId();return(await this.postgresClient.query('SELECT * FROM "stripe"."_managed_webhooks" WHERE "account_id" = $1 ORDER BY created DESC',[e])).rows}async updateManagedWebhook(e,t){let i=await this.stripe.webhookEndpoints.update(e,t),s=await this.getAccountId();return await this.upsertManagedWebhooks([i],s),i}async deleteManagedWebhook(e){return await this.stripe.webhookEndpoints.del(e),this.postgresClient.delete("_managed_webhooks",e)}async upsertManagedWebhooks(e,t,i){let s=e.map(e=>{let t={};for(let i of p)i in e&&(t[i]=e[i]);return t});return this.postgresClient.upsertManyWithTimestampProtection(s,"_managed_webhooks",t,i)}async backfillSubscriptions(e,t){let i=await this.postgresClient.findMissingEntries("subscriptions",e);await this.fetchMissingEntities(i,e=>this.stripe.subscriptions.retrieve(e)).then(e=>this.upsertSubscriptions(e,t))}backfillSubscriptionSchedules=async(e,t)=>{let i=await this.postgresClient.findMissingEntries("subscription_schedules",e);await this.fetchMissingEntities(i,e=>this.stripe.subscriptionSchedules.retrieve(e)).then(e=>this.upsertSubscriptionSchedules(e,t))};async expandEntity(e,t,i){if(this.config.autoExpandLists){for(let s of e)if(s[t]?.has_more){let e=[];for await(let t of i(s.id))e.push(t);s[t]={...s[t],data:e,has_more:!1}}}}async fetchMissingEntities(e,t){if(!e.length)return[];let i=[];for(let s of e){let e=await t(s);i.push(e)}return i}},E=(0,h.fileURLToPath)({get url(){return`file://${e.P("node_modules/.pnpm/stripe-replit-sync@1.0.0_stripe@20.0.0_@types+node@22.19.8_/node_modules/stripe-replit-sync/dist/index.js")}`}}.url),v=l.default.dirname(E);async function S(e,t,i){let s=await e.query(`SELECT EXISTS (
      SELECT 1
      FROM information_schema.tables
      WHERE table_schema = $1
      AND table_name = $2
    )`,[t,i]);return s.rows[0]?.exists||!1}async function C(e,t="stripe",i){let s=await S(e,t,"migrations"),r=await S(e,t,"_migrations");s&&!r&&(i?.info("Renaming migrations table to _migrations"),await e.query(`ALTER TABLE "${t}"."migrations" RENAME TO "_migrations"`),i?.info("Successfully renamed migrations table"))}async function k(e,t,i){i?.warn(`Migrations table is empty - dropping and recreating schema "${t}"`),await e.query(`DROP SCHEMA IF EXISTS "${t}" CASCADE`),await e.query(`CREATE SCHEMA "${t}"`),i?.info(`Schema "${t}" has been reset`)}async function A(e,t,i,s=!1){if(!c.default.existsSync(t))return void i.logger?.info(`Migrations directory ${t} not found, skipping`);try{await (0,o.migrate)({client:e},t,{schemaName:"stripe",tableName:"_migrations"})}catch(e){if(s&&e instanceof Error)i.logger?.error(e,"Migration error:");else throw e}}async function I(e){let t=new r({connectionString:e.databaseUrl,ssl:e.ssl,connectionTimeoutMillis:1e4}),i="stripe";try{if(await t.connect(),await t.query(`CREATE SCHEMA IF NOT EXISTS ${i};`),await C(t,i,e.logger),await S(t,i,"_migrations")){let s=await t.query(`SELECT COUNT(*) as count FROM "${i}"."_migrations"`);s.rows[0]?.count==="0"&&await k(t,i,e.logger)}e.logger?.info("Running migrations"),await A(t,l.default.resolve(v,"./migrations"),e)}catch(t){throw e.logger?.error(t,"Error running migrations"),t}finally{await t.end(),e.logger?.info("Finished migrations")}}e.s(["PostgresClient",()=>d,"StripeSync",()=>_,"hashApiKey",()=>b,"runMigrations",()=>I],32814)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__947f7a45._.js.map